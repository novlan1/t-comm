<!DOCTYPE html><html lang="en"><head>
    
    <meta charset="utf-8">
    <title>base/list/parse-list.ts - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger">
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search">
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/novlan1/t-comm" target="_blank" class="menu-item" id="repository">Github repo</a></h2><h3>Classes</h3><ul><li><a href="JsDocHandler.html">JsDocHandler</a><ul class="methods"><li data-type="method" style="display: none;"><a href="JsDocHandler.html#.init">init</a></li></ul></li><li><a href="MorsePwd.html">MorsePwd</a><ul class="methods"><li data-type="method" style="display: none;"><a href="MorsePwd.html#.init">init</a></li><li data-type="method" style="display: none;"><a href="MorsePwd.html#clear">clear</a></li></ul></li><li><a href="MpCI_MpCI.html">MpCI#MpCI</a></li></ul><h3>Global</h3><ul><li class="nav-separator">-------   base/function   -------</li><li><a href="global.html#parseFunction">parseFunction</a></li><li><a href="global.html#cached">cached</a></li><li class="nav-separator">---------   base/list   ---------</li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#shuffle">shuffle</a></li><li><a href="global.html#getAccCellWidth">getAccCellWidth</a></li><li><a href="global.html#isListAllEqual">isListAllEqual</a></li><li><a href="global.html#getKeyValuesMap">getKeyValuesMap</a></li><li><a href="global.html#getPreviousRatio">getPreviousRatio</a></li><li><a href="global.html#getMaxAndMinIdx">getMaxAndMinIdx</a></li><li><a href="global.html#flattenPreData">flattenPreData</a></li><li><a href="global.html#compareTwoList">compareTwoList</a></li><li class="nav-separator">--------   base/number   --------</li><li><a href="global.html#getUnitPreviousRatio">getUnitPreviousRatio</a></li><li><a href="global.html#getPartRatio">getPartRatio</a></li><li><a href="global.html#NUMBER_CHI_MAP">NUMBER_CHI_MAP</a></li><li><a href="global.html#getThousandSeparator">getThousandSeparator</a></li><li><a href="global.html#getThousandSeparator2">getThousandSeparator2</a></li><li class="nav-separator">--------   base/object   --------</li><li><a href="global.html#toHumpObj">toHumpObj</a></li><li><a href="global.html#extend">extend</a></li><li class="nav-separator">--------   base/string   --------</li><li><a href="global.html#camelize">camelize</a></li><li><a href="global.html#hyphenate">hyphenate</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#titleize">titleize</a></li><li><a href="global.html#lowerInitial">lowerInitial</a></li><li><a href="global.html#toUnicodeAt">toUnicodeAt</a></li><li><a href="global.html#toUnicode">toUnicode</a></li><li class="nav-separator">-----------   canvas   -----------</li><li><a href="global.html#addTextForImg">addTextForImg</a></li><li><a href="global.html#mergeMultiCanvasPic">mergeMultiCanvasPic</a></li><li><a href="global.html#createCanvasTable">createCanvasTable</a></li><li class="nav-separator">------------   city   ------------</li><li><a href="global.html#getAreaData">getAreaData</a></li><li><a href="global.html#getAllAreaData">getAllAreaData</a></li><li><a href="global.html#getAreaCode">getAreaCode</a></li><li><a href="global.html#getProvName">getProvName</a></li><li><a href="global.html#getCityName">getCityName</a></li><li><a href="global.html#getAreaName">getAreaName</a></li><li class="nav-separator">-----------   cookie   -----------</li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#setCookie">setCookie</a></li><li><a href="global.html#clearCookie">clearCookie</a></li><li><a href="global.html#clearAll">clearAll</a></li><li class="nav-separator">------------   cos   ------------</li><li><a href="global.html#uploadCOSFile">uploadCOSFile</a></li><li class="nav-separator">------------   css   ------------</li><li><a href="global.html#removeCss">removeCss</a></li><li class="nav-separator">------------   date   ------------</li><li><a href="global.html#getMonthDay">getMonthDay</a></li><li><a href="global.html#getMonthDay2">getMonthDay2</a></li><li><a href="global.html#isSameWeek">isSameWeek</a></li><li><a href="global.html#timeStampFormat">timeStampFormat</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#parseTime">parseTime</a></li><li><a href="global.html#getTimeAgo">getTimeAgo</a></li><li><a href="global.html#getTimeAgoOrDate">getTimeAgoOrDate</a></li><li><a href="global.html#getCountDownObj">getCountDownObj</a></li><li><a href="global.html#getDayStartTimestamp">getDayStartTimestamp</a></li><li><a href="global.html#getDayEndTimeStamp">getDayEndTimeStamp</a></li><li class="nav-separator">------------   env   ------------</li><li><a href="global.html#checkUAIsIOS">checkUAIsIOS</a></li><li><a href="global.html#getEnvUAType">getEnvUAType</a></li><li class="nav-separator">------------   git   ------------</li><li><a href="global.html#getGitCurBranch">getGitCurBranch</a></li><li><a href="global.html#getGitCommitInfo">getGitCommitInfo</a></li><li><a href="global.html#getGitLastTag">getGitLastTag</a></li><li><a href="global.html#getGitCommitsBeforeTag">getGitCommitsBeforeTag</a></li><li><a href="global.html#getGitAuthor">getGitAuthor</a></li><li class="nav-separator">-----------   loader   -----------</li><li><a href="global.html#loadJS">loadJS</a></li><li><a href="global.html#loadCSS">loadCSS</a></li><li class="nav-separator">-----------   mp-ci   -----------</li><li><a href="global.html#parseUploadResult">parseUploadResult</a></li><li class="nav-separator">----------   node-img   ----------</li><li><a href="global.html#saveBase64ImgToFile">saveBase64ImgToFile</a></li><li><a href="global.html#turnLocalImg2Base64">turnLocalImg2Base64</a></li><li><a href="global.html#saveRemoteImgToLocal">saveRemoteImgToLocal</a></li><li><a href="global.html#getImgMd5">getImgMd5</a></li><li class="nav-separator">-----   open-source-report   -----</li><li><a href="global.html#sendOpenSourceReport">sendOpenSourceReport</a></li><li class="nav-separator">----------   pipeline   ----------</li><li><a href="global.html#startPipeline">startPipeline</a></li><li class="nav-separator">----------   rainbow   ----------</li><li><a href="global.html#addOrUpdateRainbowKV">addOrUpdateRainbowKV</a></li><li><a href="global.html#addRainbowKV">addRainbowKV</a></li><li><a href="global.html#updateRainbowKV">updateRainbowKV</a></li><li><a href="global.html#createRainbowPublishJob">createRainbowPublishJob</a></li><li><a href="global.html#publishRainbowTask">publishRainbowTask</a></li><li><a href="global.html#closeRainbowTask">closeRainbowTask</a></li><li><a href="global.html#updateRainbowKVAndPublish">updateRainbowKVAndPublish</a></li><li><a href="global.html#queryGroupInfo">queryGroupInfo</a></li><li><a href="global.html#fetchRainbowConfig">fetchRainbowConfig</a></li><li class="nav-separator">-------   rainbow-to-cos   -------</li><li><a href="global.html#watchRainbowToCosAndSendRobot">watchRainbowToCosAndSendRobot</a></li><li class="nav-separator">----------   tam/img   ----------</li><li><a href="global.html#genCustomEventImgAndSendRobot">genCustomEventImgAndSendRobot</a></li><li><a href="global.html#genMultiImgAndSendRobot">genMultiImgAndSendRobot</a></li><li><a href="global.html#genSummaryDataAndSendRobot">genSummaryDataAndSendRobot</a></li><li class="nav-separator">------------   tgit   ------------</li><li><a href="global.html#getBranchLifeCycle">getBranchLifeCycle</a></li><li><a href="global.html#getProjectDefaultBranch">getProjectDefaultBranch</a></li><li><a href="global.html#getBranchesByProjectName">getBranchesByProjectName</a></li><li><a href="global.html#getOneBranchDetail">getOneBranchDetail</a></li><li><a href="global.html#getOneCommitDetail">getOneCommitDetail</a></li><li><a href="global.html#createMR">createMR</a></li><li><a href="global.html#getMrList">getMrList</a></li><li><a href="global.html#getOneMrComments">getOneMrComments</a></li><li><a href="global.html#getOneProjectDetail">getOneProjectDetail</a></li><li><a href="global.html#getOneProjectBySearch">getOneProjectBySearch</a></li><li><a href="global.html#getAllProjects">getAllProjects</a></li><li><a href="global.html#deleteTGitProject">deleteTGitProject</a></li><li class="nav-separator">------------   url   ------------</li><li><a href="global.html#getQueryObj">getQueryObj</a></li><li><a href="global.html#composeUrlQuery">composeUrlQuery</a></li><li><a href="global.html#encodeUrlParam">encodeUrlParam</a></li><li><a href="global.html#decodeUrlParam">decodeUrlParam</a></li><li class="nav-separator">------------   util   ------------</li><li><a href="global.html#buildAndUpload">buildAndUpload</a></li><li><a href="global.html#readEnvVariable">readEnvVariable</a></li><li><a href="global.html#formatBite">formatBite</a></li><li><a href="global.html#innerCopyDir">innerCopyDir</a></li><li><a href="global.html#copyDir">copyDir</a></li><li><a href="global.html#deleteFolder">deleteFolder</a></li><li><a href="global.html#copyFile">copyFile</a></li><li><a href="global.html#execCommand">execCommand</a></li><li><a href="global.html#writeEnvTokenToNpmRC">writeEnvTokenToNpmRC</a></li><li><a href="global.html#sleep">sleep</a></li><li class="nav-separator">----------   validate   ----------</li><li><a href="global.html#isIdCard">isIdCard</a></li><li><a href="global.html#isRegExp">isRegExp</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isExternal">isExternal</a></li><li><a href="global.html#validURL">validURL</a></li><li><a href="global.html#validLowerCase">validLowerCase</a></li><li><a href="global.html#validUpperCase">validUpperCase</a></li><li><a href="global.html#validAlphabets">validAlphabets</a></li><li><a href="global.html#validEmail">validEmail</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isQQNumber">isQQNumber</a></li><li><a href="global.html#isEmail">isEmail</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isTel">isTel</a></li><li class="nav-separator">--------   version-tip   --------</li><li><a href="global.html#genVersionAndSendChangeLog">genVersionAndSendChangeLog</a></li><li><a href="global.html#genVersionTip">genVersionTip</a></li><li><a href="global.html#genVersion">genVersion</a></li><li class="nav-separator">----------   weather   ----------</li><li><a href="global.html#fetchWeatherData">fetchWeatherData</a></li><li><a href="global.html#sendWeatherRobotMsg">sendWeatherRobotMsg</a></li><li><a href="global.html#getWeatherRobotContent">getWeatherRobotContent</a></li><li class="nav-separator">--------   wecom-robot   --------</li><li><a href="global.html#sendWxRobotMsg">sendWxRobotMsg</a></li><li><a href="global.html#sendWxRobotMarkdown">sendWxRobotMarkdown</a></li><li><a href="global.html#sendWxRobotImg">sendWxRobotImg</a></li><li><a href="global.html#batchSendWxRobotBase64Img">batchSendWxRobotBase64Img</a></li><li><a href="global.html#sendWxRobotBase64Img">sendWxRobotBase64Img</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">base/list/parse-list.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { getUnitPreviousRatio } from '../number';

/**
 * 判断数组是否全部相等
 * @param {Array&lt;number | string&gt;} list - 数组
 * @returns {Boolean} 是否全部相等
 *
 * @example
 * isListAllEqual([0, 0, 0])
 *
 * // true
 *
 * isListAllEqual([0, 0, 2])
 *
 * // false
 */
export function isListAllEqual(list: Array&lt;number|string&gt; = []) {
  if (!list.length) return true;
  const value = list[0];
  for (const item of list.slice(1)) {
    if (item !== value) return false;
  }

  return true;
}

/**
 * 获取对象的value列表，并输出大对象形式
 * @param {Array&lt;any&gt;} data
 * @returns {Object} 处理后的对象
 *
 * @example
 *
 * const data = [
 * {
 *   Project: 'x',
 *   Request: 1,
 *   Score: 'a'
 * },
 * {
 *   Project: 'y',
 *   Request: 2,
 *   Score: 'b'
 * }]
 *
 * getKeyValuesMap(data)
 *
 * // 结果为:
 * {
 *   Project: ['x', 'y'],
 *   Request: [1, 2],
 *   Score: ['a', 'b'],
 * }
 *
 * // 也支持参数为带value属性的对象数组，如：
 *
 * const data = [
 * {
 *   Project: {
 *     value: 'x'
 *   }
 * },{
 *   Project: {
 *     value: 'y'
 *   }
 * }]
 *
 * // 结果为：
 * {
 *   Project: ['x', 'y']
 * }
 */
export function getKeyValuesMap(data: Array&lt;any&gt; = []) {
  if (!data.length) return {};
  const keys = Object.keys(data[0]);
  const keyValueMap = {};

  data.forEach((item) =&gt; {
    keys.forEach((key) =&gt; {
      // 如果有value，就取value，否则直接取item[key]
      const value = item[key]?.value || item[key];

      if (keyValueMap[key]) {
        keyValueMap[key].push(value);
      } else {
        keyValueMap[key] = [value];
      }
    });
  });
  return keyValueMap;
}

/**
 * 标记最大最小值
 * @private
 * @param {object} params 参数对象
 * @param {Array&lt;number&gt;} params.values 待处理的数组
 * @param {number} params.value 当前值
 * @param {Object} params.obj 迭代中的对象
 * @returns {Object} 处理后的对象
 */
function markMaxAndMinOfObj({ values, value, obj }) {
  const idx = values.indexOf(value);
  const lastIdx = values.indexOf(value);

  let newObj = {
    ...obj,
    idx,
    lastIdx,
  };

  if (!isListAllEqual(values)) {
    const len = values.length;
    const isMax = idx === 0;
    const isSecondMax = idx === 1;
    const isMin = idx === len - 1;
    const isSecondMin = idx === len - 2;

    newObj = {
      ...newObj,
      isMax,
      isMin,
      isSecondMax,
      isSecondMin,
    };
  }
  return newObj;
}

/**
 * 获取相对上次的比例，会给输入的对象数组的每一项增加 ratio、previousValue 属性
 * @param {Array&lt;Object&gt;} data - 输入数据
 * @param {Object} preDataMap - 上次数据的map
 * @param {string} uniqKey - 唯一键
 *
 * @example
 * const data = [{
 *   Project: { value: 'mj-match', name: 'Project' },
 *   Request: {
 *     value: 854,
 *     name: 'Request',
 *     idx: 19,
 *     lastIdx: 19,
 *     isMax: false,
 *     isMin: false,
 *     isSecondMax: false,
 *     isSecondMin: true,
 *   },
 * }];
 *
 * const preDataMap = {
 *   'mj-match': {
 *     Project: 'mj-match',
 *     Request: 4,
 *     Score: 91.81,
 *     FirstLoadTime: 178,
 *     WholePageTime: 1035,
 *     ParseDomTime: 484,
 *     DNSLinkTime: 0,
 *     DOMTime: 414,
 *     TCP: 0,
 *     HTTP: 275,
 *     BackEnd: 60,
 *     CGIFailNum: 0,
 *     ErrorLogNum: 0,
 *     CGIRequestNum: 83,
 *   },
 * };
 *
 * getPreviousRatio(data, preDataMap);
 *
 * // data会变成：
 * [{
 *   Project: { value: 'mj-match', name: 'Project' },
 *   Request: {
 *     value: 854,
 *     name: 'Request',
 *     idx: 19,
 *     lastIdx: 19,
 *     isMax: false,
 *     isMin: false,
 *     isSecondMax: false,
 *     isSecondMin: true,
 *
 *     previousValue: 4, // 新增属性
 *     ratio: "+999+%" // 新增属性
 *   },
 * }];
 */
export function getPreviousRatio(
  data = [],
  preDataMap = {},
  uniqKey = 'Project',
) {
  data.forEach((item) =&gt; {
    Object.keys(item).forEach((key) =&gt; {
      const obj = item[key] as any;

      if (typeof obj.value === 'number') {
        const uniqVal = (item[uniqKey] as any).value;
        const preValue = preDataMap?.[uniqVal]?.[key];

        if (preValue === undefined) {
          obj.ratio = '';
        } else {
          obj.ratio = getUnitPreviousRatio(obj.value, preValue);
          obj.previousValue = preValue;
        }
      }
    });
  });
}

/**
 * 给对象数组的每一项，添加isMax、isMin、、isSecondMax、isSecondMin、idx、lastIdx等属性
 * @param {Array&lt;object&gt;} data 原始数据
 * @param {Array&lt;string&gt;} reverseScoreKeys - 逆序的key列表
 * @returns {Object} 处理后的数据
 *
 * @example
 * const data = [{
 *   ProjectName: { name: 'ProjectName', value: '麻将赛事' },
 *   PagePv: { name: 'PagePv', value: 2877 },
 * }, {
 *   ProjectName: { name: 'ProjectName', value: '斗地主赛事' },
 *   PagePv: { name: 'PagePv', value: 7 },
 * },
 * // ...
 * ];
 *
 * getMaxAndMinIdx(data, [])
 *
 * // =&gt;
 *   [{
 *     ProjectName: { name: 'ProjectName', value: '麻将赛事' },
 *     PagePv: {
 *       name: 'PagePv',
 *       value: 2877,
 *       idx: 6,
 *       lastIdx: 6,
 *       isMax: false,
 *       isMin: false,
 *       isSecondMax: false,
 *       isSecondMin: false,
 *     },
 *   }];
 *
 */
export function getMaxAndMinIdx(
  data: Array&lt;object&gt; = [],
  reverseScoreKeys: Array&lt;string&gt; = [],
) {
  if (!data.length) return [];
  const keys = Object.keys(data[0]);

  const keyValueMap = getKeyValuesMap(data);

  const parsedData = data.map((item) =&gt; {
    const temp = { ...(item as any) };

    keys.forEach((key) =&gt; {
      const values = keyValueMap[key];
      const itemInfo = item[key] || {};

      if (values &amp;&amp; typeof itemInfo.value === 'number') {
        if (reverseScoreKeys.indexOf(key) &gt; -1) {
          values.sort((a, b) =&gt; a - b);
        } else {
          values.sort((a, b) =&gt; b - a);
        }

        temp[key] = markMaxAndMinOfObj({
          values,
          value: itemInfo.value,
          obj: temp[key],
        });
      }
    });
    return temp;
  });

  return parsedData;
}

/**
 * 拉平之前数据
 * @param {Array&lt;Object&gt;} preDataList 之前的数据，作为对照
 * @param {string} key 主键
 * @returns {Object} preDataMap
 *
 * @example
 * const data = [{
 *   ProjectName: { name: 'ProjectName', value: '研发平台' },
 *   PagePv: { name: 'PagePv', value: 152 },
 *   PageUv: { name: 'PageUv', value: 7 },
 *   Score: { name: 'Score', value: 93.92 },
 *   PageDuration: { name: 'PageDuration', value: 1281.58 },
 *   PageError: { name: 'PageError', value: 2 },
 * }];
 *
 * flattenPreData(data, 'ProjectName');
 *
 * // 输出
 * {
 *   研发平台: {
 *     ProjectName: '研发平台',
 *     PagePv: 152,
 *     PageUv: 7,
 *     Score: 93.92,
 *     PageDuration: 1281.58,
 *     PageError: 2,
 *   },
 * };
 */
export function flattenPreData(preDataList: Array&lt;{
  [key: string]: {
    name: string
    value: number | string
  }
}&gt;, key: string): {
    [valueOfPrimaryKey: string]: {
      [key: string]: string | number
    }
  } {
  const preDataMap = preDataList.reduce((acc, item) =&gt; {
    acc[item[key]?.value || 'DEFAULT_KEY'] = Object.values(item).reduce((ac: any, it: any) =&gt; {
      ac[it.name] = it.value;
      return ac;
    }, {});
    return acc;
  }, {});
  return preDataMap;
}


/**
 * 对比两个对象列表
 * @param {Array&lt;object&gt;} list 现在数据
 * @param {Array&lt;object&gt;} preList 参照数据
 * @param {string} key 唯一key名称
 * @return {Array&lt;object&gt;} 对比结果，增加为list的每一项增加previousValue和ratio属性
 * @example
 * const list = [
 *   {
 *     ProjectName: { name: 'ProjectName', value: '脚手架' },
 *     PagePv: { name: 'PagePv', value: 544343 },
 *     PageUv: { name: 'PageUv', value: 225275 },
 *   }
 * ]
 *
 * const preList = [
 *   {
 *     ProjectName: { name: 'ProjectName', value: '脚手架' },
 *     PagePv: { name: 'PagePv', value: 123123 },
 *     PageUv: { name: 'PageUv', value: 33333 },
 *   }
 * ]
 *
 * compareTwoList(list, preList, 'ProjectName')
 *
 * console.log(list)
 *
 * [
 *   {
 *     ProjectName: { name: 'ProjectName', value: '脚手架' },
 *     PagePv: {
 *       name: 'PagePv',
 *       value: 544343,
 *       ratio: '+342.1%',
 *       previousValue: 123123
 *     },
 *     PageUv: {
 *       name: 'PageUv',
 *       value: 225275,
 *       ratio: '+575.8%',
 *       previousValue: 33333
 *     }
 *   }
 * ]
 */
export function compareTwoList(list, preList, key) {
  const preDataMap = flattenPreData(preList, key);
  getPreviousRatio(list, preDataMap, key);
  return list;
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>Documentation generated on 2022-11-19 03:16:39 GMT+0000  by novlan1.</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer=""></script>


<script src="scripts/collapse.js" defer=""></script>


    <script src="./jsdoc.js"></script>
    


</body></html>