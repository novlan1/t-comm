<!DOCTYPE html><html lang="en"><head>
    
    <meta charset="utf-8">
    <title>mp-ci/mp-ci.ts - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger">
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search">
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/novlan1/t-comm" target="_blank" class="menu-item" id="repository">Github repo</a></h2><h3>Classes</h3><ul><li><a href="JsDocHandler.html">JsDocHandler</a><ul class="methods"><li data-type="method" style="display: none;"><a href="JsDocHandler.html#.init">init</a></li></ul></li><li><a href="MorsePwd.html">MorsePwd</a><ul class="methods"><li data-type="method" style="display: none;"><a href="MorsePwd.html#.init">init</a></li><li data-type="method" style="display: none;"><a href="MorsePwd.html#clear">clear</a></li></ul></li><li><a href="MpCI_MpCI.html">MpCI#MpCI</a></li></ul><h3>Global</h3><ul><li class="nav-separator">-------   base/function   -------</li><li><a href="global.html#parseFunction">parseFunction</a></li><li><a href="global.html#cached">cached</a></li><li class="nav-separator">---------   base/list   ---------</li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#shuffle">shuffle</a></li><li><a href="global.html#getAccCellWidth">getAccCellWidth</a></li><li><a href="global.html#isListAllEqual">isListAllEqual</a></li><li><a href="global.html#getKeyValuesMap">getKeyValuesMap</a></li><li><a href="global.html#getPreviousRatio">getPreviousRatio</a></li><li><a href="global.html#getMaxAndMinIdx">getMaxAndMinIdx</a></li><li><a href="global.html#flattenPreData">flattenPreData</a></li><li><a href="global.html#compareTwoList">compareTwoList</a></li><li class="nav-separator">--------   base/number   --------</li><li><a href="global.html#getUnitPreviousRatio">getUnitPreviousRatio</a></li><li><a href="global.html#getPartRatio">getPartRatio</a></li><li><a href="global.html#NUMBER_CHI_MAP">NUMBER_CHI_MAP</a></li><li><a href="global.html#getThousandSeparator">getThousandSeparator</a></li><li><a href="global.html#getThousandSeparator2">getThousandSeparator2</a></li><li class="nav-separator">--------   base/object   --------</li><li><a href="global.html#toHumpObj">toHumpObj</a></li><li><a href="global.html#extend">extend</a></li><li class="nav-separator">--------   base/string   --------</li><li><a href="global.html#camelize">camelize</a></li><li><a href="global.html#hyphenate">hyphenate</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#titleize">titleize</a></li><li><a href="global.html#lowerInitial">lowerInitial</a></li><li><a href="global.html#toUnicodeAt">toUnicodeAt</a></li><li><a href="global.html#toUnicode">toUnicode</a></li><li class="nav-separator">-----------   canvas   -----------</li><li><a href="global.html#addTextForImg">addTextForImg</a></li><li><a href="global.html#mergeMultiCanvasPic">mergeMultiCanvasPic</a></li><li><a href="global.html#createCanvasTable">createCanvasTable</a></li><li class="nav-separator">------------   city   ------------</li><li><a href="global.html#getAreaData">getAreaData</a></li><li><a href="global.html#getAllAreaData">getAllAreaData</a></li><li><a href="global.html#getAreaCode">getAreaCode</a></li><li><a href="global.html#getProvName">getProvName</a></li><li><a href="global.html#getCityName">getCityName</a></li><li><a href="global.html#getAreaName">getAreaName</a></li><li class="nav-separator">-----------   cookie   -----------</li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#setCookie">setCookie</a></li><li><a href="global.html#clearCookie">clearCookie</a></li><li><a href="global.html#clearAll">clearAll</a></li><li class="nav-separator">------------   cos   ------------</li><li><a href="global.html#uploadCOSFile">uploadCOSFile</a></li><li class="nav-separator">------------   css   ------------</li><li><a href="global.html#removeCss">removeCss</a></li><li class="nav-separator">------------   date   ------------</li><li><a href="global.html#getMonthDay">getMonthDay</a></li><li><a href="global.html#getMonthDay2">getMonthDay2</a></li><li><a href="global.html#isSameWeek">isSameWeek</a></li><li><a href="global.html#timeStampFormat">timeStampFormat</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#parseTime">parseTime</a></li><li><a href="global.html#getTimeAgo">getTimeAgo</a></li><li><a href="global.html#getTimeAgoOrDate">getTimeAgoOrDate</a></li><li><a href="global.html#getCountDownObj">getCountDownObj</a></li><li><a href="global.html#getDayStartTimestamp">getDayStartTimestamp</a></li><li><a href="global.html#getDayEndTimeStamp">getDayEndTimeStamp</a></li><li class="nav-separator">------------   env   ------------</li><li><a href="global.html#checkUAIsIOS">checkUAIsIOS</a></li><li><a href="global.html#getEnvUAType">getEnvUAType</a></li><li class="nav-separator">------------   git   ------------</li><li><a href="global.html#getGitCurBranch">getGitCurBranch</a></li><li><a href="global.html#getGitCommitInfo">getGitCommitInfo</a></li><li><a href="global.html#getGitLastTag">getGitLastTag</a></li><li><a href="global.html#getGitCommitsBeforeTag">getGitCommitsBeforeTag</a></li><li><a href="global.html#getGitAuthor">getGitAuthor</a></li><li class="nav-separator">-----------   loader   -----------</li><li><a href="global.html#loadJS">loadJS</a></li><li><a href="global.html#loadCSS">loadCSS</a></li><li class="nav-separator">-----------   mp-ci   -----------</li><li><a href="global.html#parseUploadResult">parseUploadResult</a></li><li class="nav-separator">----------   node-img   ----------</li><li><a href="global.html#saveBase64ImgToFile">saveBase64ImgToFile</a></li><li><a href="global.html#turnLocalImg2Base64">turnLocalImg2Base64</a></li><li><a href="global.html#saveRemoteImgToLocal">saveRemoteImgToLocal</a></li><li><a href="global.html#getImgMd5">getImgMd5</a></li><li class="nav-separator">-----   open-source-report   -----</li><li><a href="global.html#sendOpenSourceReport">sendOpenSourceReport</a></li><li class="nav-separator">----------   pipeline   ----------</li><li><a href="global.html#startPipeline">startPipeline</a></li><li class="nav-separator">----------   rainbow   ----------</li><li><a href="global.html#addOrUpdateRainbowKV">addOrUpdateRainbowKV</a></li><li><a href="global.html#addRainbowKV">addRainbowKV</a></li><li><a href="global.html#updateRainbowKV">updateRainbowKV</a></li><li><a href="global.html#createRainbowPublishJob">createRainbowPublishJob</a></li><li><a href="global.html#publishRainbowTask">publishRainbowTask</a></li><li><a href="global.html#closeRainbowTask">closeRainbowTask</a></li><li><a href="global.html#updateRainbowKVAndPublish">updateRainbowKVAndPublish</a></li><li><a href="global.html#queryGroupInfo">queryGroupInfo</a></li><li><a href="global.html#fetchRainbowConfig">fetchRainbowConfig</a></li><li class="nav-separator">-------   rainbow-to-cos   -------</li><li><a href="global.html#watchRainbowToCosAndSendRobot">watchRainbowToCosAndSendRobot</a></li><li class="nav-separator">----------   tam/img   ----------</li><li><a href="global.html#genCustomEventImgAndSendRobot">genCustomEventImgAndSendRobot</a></li><li><a href="global.html#genMultiImgAndSendRobot">genMultiImgAndSendRobot</a></li><li><a href="global.html#genSummaryDataAndSendRobot">genSummaryDataAndSendRobot</a></li><li class="nav-separator">------------   tgit   ------------</li><li><a href="global.html#getBranchLifeCycle">getBranchLifeCycle</a></li><li><a href="global.html#getProjectDefaultBranch">getProjectDefaultBranch</a></li><li><a href="global.html#getBranchesByProjectName">getBranchesByProjectName</a></li><li><a href="global.html#getOneBranchDetail">getOneBranchDetail</a></li><li><a href="global.html#getOneCommitDetail">getOneCommitDetail</a></li><li><a href="global.html#createMR">createMR</a></li><li><a href="global.html#getMrList">getMrList</a></li><li><a href="global.html#getOneMrComments">getOneMrComments</a></li><li><a href="global.html#getOneProjectDetail">getOneProjectDetail</a></li><li><a href="global.html#getOneProjectBySearch">getOneProjectBySearch</a></li><li><a href="global.html#getAllProjects">getAllProjects</a></li><li><a href="global.html#deleteTGitProject">deleteTGitProject</a></li><li class="nav-separator">------------   url   ------------</li><li><a href="global.html#getQueryObj">getQueryObj</a></li><li><a href="global.html#composeUrlQuery">composeUrlQuery</a></li><li><a href="global.html#encodeUrlParam">encodeUrlParam</a></li><li><a href="global.html#decodeUrlParam">decodeUrlParam</a></li><li class="nav-separator">------------   util   ------------</li><li><a href="global.html#buildAndUpload">buildAndUpload</a></li><li><a href="global.html#readEnvVariable">readEnvVariable</a></li><li><a href="global.html#formatBite">formatBite</a></li><li><a href="global.html#innerCopyDir">innerCopyDir</a></li><li><a href="global.html#copyDir">copyDir</a></li><li><a href="global.html#deleteFolder">deleteFolder</a></li><li><a href="global.html#copyFile">copyFile</a></li><li><a href="global.html#traverseFolder">traverseFolder</a></li><li><a href="global.html#execCommand">execCommand</a></li><li><a href="global.html#writeEnvTokenToNpmRC">writeEnvTokenToNpmRC</a></li><li><a href="global.html#statisticsPages">statisticsPages</a></li><li><a href="global.html#statisticsComponent">statisticsComponent</a></li><li><a href="global.html#sleep">sleep</a></li><li class="nav-separator">----------   validate   ----------</li><li><a href="global.html#isIdCard">isIdCard</a></li><li><a href="global.html#isRegExp">isRegExp</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isExternal">isExternal</a></li><li><a href="global.html#validURL">validURL</a></li><li><a href="global.html#validLowerCase">validLowerCase</a></li><li><a href="global.html#validUpperCase">validUpperCase</a></li><li><a href="global.html#validAlphabets">validAlphabets</a></li><li><a href="global.html#validEmail">validEmail</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isQQNumber">isQQNumber</a></li><li><a href="global.html#isEmail">isEmail</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isTel">isTel</a></li><li class="nav-separator">--------   version-tip   --------</li><li><a href="global.html#genVersionAndSendChangeLog">genVersionAndSendChangeLog</a></li><li><a href="global.html#genVersionTip">genVersionTip</a></li><li><a href="global.html#genVersion">genVersion</a></li><li class="nav-separator">----------   weather   ----------</li><li><a href="global.html#fetchWeatherData">fetchWeatherData</a></li><li><a href="global.html#sendWeatherRobotMsg">sendWeatherRobotMsg</a></li><li><a href="global.html#getWeatherRobotContent">getWeatherRobotContent</a></li><li class="nav-separator">--------   wecom-robot   --------</li><li><a href="global.html#sendWxRobotMsg">sendWxRobotMsg</a></li><li><a href="global.html#sendWxRobotMarkdown">sendWxRobotMarkdown</a></li><li><a href="global.html#sendWxRobotImg">sendWxRobotImg</a></li><li><a href="global.html#batchSendWxRobotBase64Img">batchSendWxRobotBase64Img</a></li><li><a href="global.html#sendWxRobotBase64Img">sendWxRobotBase64Img</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">mp-ci/mp-ci.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable @typescript-eslint/no-require-imports */
import { sendWxRobotMarkdown } from '../wecom-robot/base';
import { getGitCommitInfo } from '../git/git';
import { timeStampFormat } from '../date/time';
import { addTextForImg } from '../canvas/img-text';
import { uploadCOSFile } from '../cos/cos';
import { saveBase64ImgToFile } from '../node-img/img';
import { formatBite } from '../util/format-bite';

import { getBundleBuildDesc, getBundleVersion, parseUploadResult } from './helper';
import { OptionsType } from './type';
import { DEFAULT_BUILD_SETTING, MAX_TRY_TIMES_MAP, PREVIEW_IMG_MAX_WORD_LENGTH } from './config';

function flattenSubPackages(result) {
  const {
    subPackageInfo,
  } = result;
  return subPackageInfo.reduce((acc, item) =&gt; {
    acc[item.name] = item;
    return acc;
  }, {});
}

function getFullPackageSize(result) {
  const obj = flattenSubPackages(result);
  return formatBite(obj.__FULL__.size);
}

function getMainPackageSize(result) {
  const obj = flattenSubPackages(result);
  return formatBite(obj.__APP__.size);
}


export class MpCI {
  ciLib: any;
  options: OptionsType;

  projectCI: any;
  savePreviewPath: any;

  appId: string;
  appName: string;
  type: string;
  root: string;
  ignores: Array&lt;string&gt;;
  pkgFile: string;
  env: string;
  robotNumber: number;
  webhookUrl?: string = '';
  chatId?: string = '';

  buildSetting: any;
  projectPath: string;
  privateKeyPath: string;
  cosInfo: any;
  commitInfo: any;
  buildDesc: string;
  buildTime?: string;
  version: string;
  previewResult: Object;
  errorLink?: string;

  tryTimesMap = {
    UPLOAD: 1,
    PREVIEW: 1,
  };

  /**
  * 小程序自动化构建工具
  * @param {object} options 选项
  *
  * @example
  *
  * const { MpCI, fetchRainbowConfig } = require('t-comm');
  *
  * const env = \"${env}\"
  * const branch = \"${branch}\"
  *
  * const root = \"${WORKSPACE}\";
  *
  * async function getCIConfig() {
  *   let res = {};
  *   const str = await fetchRainbowConfig('mp_ci', {
  *     appId: '',
  *     envName: 'x',
  *     groupName: 'x',
  *   });
  *   try {
  *     res = JSON.parse(str);
  *   } catch (err) {}
  *   return res;
  * }
  *
  * function getRobot(config = {}) {
  *   return config?.robotMap?.[branch]?.[env] || 1;
  * }
  *
  * async function main() {
  *   const config = await getCIConfig();
  *   console.log('config: \n', config, typeof config);
  *   const {
  *     appName,
  *     appId,
  *     webhookUrl,
  *     chatId,
  *     cosInfo,
  *   } = config;
  *
  *   const ci = new MpCI({
  *     appName,
  *     appId,
  *     root,
  *     env,
  *     robotNumber: getRobot(config),
  *
  *     webhookUrl,
  *     chatId,
  *
  *     cosInfo,
  *   });
  *
  *   await ci.upload();
  *   await ci.preview();
  *   await ci.sendRobotMsg();
  * }
  *
  * main();
  */
  constructor(options: OptionsType) {
    const path = require('path');
    const fs = require('fs');
    let ci;
    try {
      ci = require('miniprogram-ci');
    } catch (err) {
      console.log('[MpCI] err', err);
    }
    this.ciLib = ci;

    this.options = options;
    this.projectCI = null;
    this.previewResult = {};
    this.savePreviewPath = path.resolve(process.cwd(), 'mp_ci_preview_destination.png');
    const {
      appId,
      appName,
      projectPath,
      privateKeyPath,
      ignores,
      type,
      root,
      env,
      robotNumber,
      buildSetting,

      webhookUrl,
      chatId,
      cosInfo,
      errorLink,
    } = options;

    this.appId = appId;
    this.appName = appName || '';
    this.type = type || 'miniProgram';

    this.root = root || process.cwd();
    this.ignores = ignores || ['node_modules/**/*'];
    this.pkgFile = path.resolve(this.root, './package.json');

    this.env = env || 'test';
    this.robotNumber = robotNumber || 30;

    this.webhookUrl = webhookUrl;
    this.chatId = chatId;

    this.buildSetting = {
      ...DEFAULT_BUILD_SETTING,
      ...(buildSetting || {}),

    };
    this.projectPath = projectPath || '';
    this.privateKeyPath = privateKeyPath || '';
    this.cosInfo = cosInfo || {};
    this.errorLink = errorLink || '';

    if (!this.projectPath) {
      this.projectPath = path.resolve(this.root, 'dist/build/mp-weixin');
    }
    if (!this.privateKeyPath) {
      this.privateKeyPath = path.resolve(this.root, 'private.key');
    }

    if (this.ciLib &amp;&amp; !fs.existsSync(this.privateKeyPath)) {
      throw new Error('ERROR: privateKeyPath 位置不存在');
    }
    if (!fs.existsSync(this.projectPath)) {
      throw new Error('ERROR: projectPath 位置不存在');
    }

    if (!fs.existsSync(this.pkgFile)) {
      throw new Error('ERROR: package.json 不存在');
    }

    if (this.ciLib) {
      this.init();
    }

    this.getBuildTime();

    this.commitInfo = getGitCommitInfo(this.root);
    this.buildDesc = getBundleBuildDesc({
      root: this.root,
      env: this.env,
    }) || '';
    this.version = getBundleVersion(this.root);
  }

  init() {
    const { appId, projectPath, privateKeyPath, ignores, type } = this;

    this.projectCI = new this.ciLib.Project({
      appid: appId,
      type,
      projectPath,
      privateKeyPath,
      ignores,
    });
  }

  getBuildTime() {
    this.buildTime = timeStampFormat(Date.now(), 'yyyy-MM-dd hh:mm:ss');
  }

  /**
   * 上传
   */
  async upload() {
    try {
      await this.tryUpload();
    } catch (err) {
      if (this.tryTimesMap.UPLOAD &lt; MAX_TRY_TIMES_MAP.UPLOAD) {
        this.tryTimesMap.UPLOAD += 1;

        await this.tryUpload();
      } else {
        throw new Error(err as any);
      }
    }
  }

  async tryUpload() {
    const { robotNumber, version, buildDesc } = this;

    const uploadResult = await this.ciLib.upload({
      project: this.projectCI,
      version,
      desc: buildDesc,
      robot: robotNumber,
      setting: this.buildSetting,
    });
    this.getBuildTime();
    await this.ciLib.getDevSourceMap({
      project: this.projectCI,
      robot: robotNumber,
      sourceMapSavePath: './sm.zip',
    });
    console.log('[MpCI] UploadResult:\n', uploadResult);
  }

  async preview() {
    try {
      await this.tryPreview();
    } catch (err) {
      if (this.tryTimesMap.UPLOAD &lt; MAX_TRY_TIMES_MAP.UPLOAD) {
        this.tryTimesMap.UPLOAD += 1;

        await this.tryPreview();
      }
    }
  }

  /**
   * 预览
   */
  async tryPreview() {
    const previewResult = await this.ciLib.preview({
      project: this.projectCI,
      desc: this.buildDesc,
      setting: this.buildSetting,
      qrcodeFormat: 'image',
      qrcodeOutputDest: this.savePreviewPath,
      robot: this.robotNumber,
      // pagePath: 'pages/index/index', // 预览页面
      // searchQuery: 'a=1&amp;b=2',  // 预览参数 [注意!]这里的`&amp;`字符在命令行中应写成转义字符`&amp;`
    });
    console.log('[MpCI] PreviewResult:\n', previewResult);

    this.previewResult = previewResult;
    await this.uploadPreviewImg(previewResult);
  }

  /**
   * 上传预览图片到COS
   */
  async uploadPreviewImg(previewResult) {
    const { robotNumber, env, buildTime, commitInfo, version } = this;

    const textList = [
      '[CI RESULT]',
      `VERSION: ${version}`,
      `UPLOADER: CI ROBOT ${robotNumber}`,
      `ENV: ${env}`,
      `BRANCH: ${commitInfo.branch}`,
      `BUILD TIME: ${buildTime}`,
      `LAST COMMIT: ${commitInfo.author} - ${commitInfo.message} - ${commitInfo.hash}`,
      ...parseUploadResult(previewResult),
    ].map((item) =&gt; {
      if (item.length &gt; PREVIEW_IMG_MAX_WORD_LENGTH) return `${item.slice(0, PREVIEW_IMG_MAX_WORD_LENGTH)}...`;
      return item;
    });

    const newPreviewImg = await addTextForImg({
      width: 300,
      height: 300,
      imgPath: this.savePreviewPath,
      textList,
    });

    await saveBase64ImgToFile({
      imgUrl: newPreviewImg,
      savePath: this.savePreviewPath,
    });
    this.uploadFiles([
      {
        key: this.getCosKey(),
        path: this.savePreviewPath,
      },
    ]);
  }

  getCosKey() {
    const { cosInfo, env, commitInfo } = this;
    return `${cosInfo.dir}/${commitInfo.branch.replace(/\//g, '-')}_${env}.png`;
  }

  getCOSFilePath() {
    const { bucket, region } = this.cosInfo;
    const cosKey = this.getCosKey();
    return `https://${bucket}.cos.${region}.myqcloud.com/${cosKey}`;
  }

  /**
   * 发送机器人消息
   */
  async sendRobotMsg(hasImg = true) {
    const { robotNumber, webhookUrl, env, commitInfo, version, previewResult, appName } = this;
    let { chatId } = this;
    if (!webhookUrl) {
      return;
    }
    if (!chatId) {
      chatId = undefined;
    }

    const descList = [
      `分支：${commitInfo.branch}`,
      `环境：${env}`,
      `版本：${version || ''}`,
      `机器人：${robotNumber}`,
      `最后提交: ${commitInfo.author} - ${commitInfo.message} - ${commitInfo.hash}`,
      `总包：${getFullPackageSize(previewResult)}`,
      `主包：${getMainPackageSize(previewResult)}`,
      // `${buildTime || ''}`,
    ];

    if (hasImg) {
      descList.push(`[预览图片](${this.getCOSFilePath()})`);
    }

    const template = `&gt;【${appName || ''}微信小程序构建成功】${descList.join('，')}`;

    sendWxRobotMarkdown({
      webhookUrl,
      content: template,
      chatId,
    });
  }

  async uploadAndPreview() {
    try {
      await Promise.all([this.upload(), this.preview()]);
    } catch (err) {
      console.log('[MpCI] err', err);

      const { webhookUrl, errorLink } = this;
      let { chatId } = this;
      if (!webhookUrl) {
        return;
      }
      if (!chatId) {
        chatId = undefined;
      }

      const errorContent = `${errorLink ? `[构建失败](${errorLink})` : ''}${(err as any).toString()}`;

      sendWxRobotMarkdown({
        webhookUrl,
        content: errorContent,
        chatId,
      });
    }
  }

  async uploadFiles(files) {
    const { secretId, secretKey, bucket, region } = this.cosInfo || {};
    await uploadCOSFile({
      files,
      secretId,
      secretKey,
      bucket,
      region,
    });
  }
}


</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>Documentation generated on 2023-03-10 04:15:59 GMT+0000  by novlan1.</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer=""></script>


<script src="scripts/collapse.js" defer=""></script>


    <script src="./jsdoc.js"></script>
    


</body></html>