<!DOCTYPE html><html lang="en"><head>
    
    <meta charset="utf-8">
    <title>jsdoc/jsdoc.ts - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger">
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search">
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/novlan1/t-comm" target="_blank" class="menu-item" id="repository">Github repo</a></h2><h3>Classes</h3><ul><li><a href="JsDocHandler.html">JsDocHandler</a><ul class="methods"><li data-type="method" style="display: none;"><a href="JsDocHandler.html#.init">init</a></li></ul></li><li><a href="MorsePwd.html">MorsePwd</a><ul class="methods"><li data-type="method" style="display: none;"><a href="MorsePwd.html#.init">init</a></li><li data-type="method" style="display: none;"><a href="MorsePwd.html#clear">clear</a></li></ul></li><li><a href="MpCI_MpCI.html">MpCI#MpCI</a></li></ul><h3>Global</h3><ul><li class="nav-separator">-------   base/function   -------</li><li><a href="global.html#parseFunction">parseFunction</a></li><li><a href="global.html#cached">cached</a></li><li class="nav-separator">---------   base/list   ---------</li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#shuffle">shuffle</a></li><li><a href="global.html#getAccCellWidth">getAccCellWidth</a></li><li><a href="global.html#isListAllEqual">isListAllEqual</a></li><li><a href="global.html#getKeyValuesMap">getKeyValuesMap</a></li><li><a href="global.html#getPreviousRatio">getPreviousRatio</a></li><li><a href="global.html#getMaxAndMinIdx">getMaxAndMinIdx</a></li><li><a href="global.html#flattenPreData">flattenPreData</a></li><li><a href="global.html#compareTwoList">compareTwoList</a></li><li class="nav-separator">--------   base/number   --------</li><li><a href="global.html#getUnitPreviousRatio">getUnitPreviousRatio</a></li><li><a href="global.html#getPartRatio">getPartRatio</a></li><li><a href="global.html#NUMBER_CHI_MAP">NUMBER_CHI_MAP</a></li><li><a href="global.html#getThousandSeparator">getThousandSeparator</a></li><li><a href="global.html#getThousandSeparator2">getThousandSeparator2</a></li><li class="nav-separator">--------   base/object   --------</li><li><a href="global.html#toHumpObj">toHumpObj</a></li><li><a href="global.html#extend">extend</a></li><li class="nav-separator">--------   base/string   --------</li><li><a href="global.html#camelize">camelize</a></li><li><a href="global.html#hyphenate">hyphenate</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#titleize">titleize</a></li><li><a href="global.html#lowerInitial">lowerInitial</a></li><li><a href="global.html#toUnicodeAt">toUnicodeAt</a></li><li><a href="global.html#toUnicode">toUnicode</a></li><li class="nav-separator">-----------   canvas   -----------</li><li><a href="global.html#addTextForImg">addTextForImg</a></li><li><a href="global.html#mergeMultiCanvasPic">mergeMultiCanvasPic</a></li><li><a href="global.html#createCanvasTable">createCanvasTable</a></li><li class="nav-separator">------------   city   ------------</li><li><a href="global.html#getAreaData">getAreaData</a></li><li><a href="global.html#getAllAreaData">getAllAreaData</a></li><li><a href="global.html#getAreaCode">getAreaCode</a></li><li><a href="global.html#getProvName">getProvName</a></li><li><a href="global.html#getCityName">getCityName</a></li><li><a href="global.html#getAreaName">getAreaName</a></li><li class="nav-separator">-----------   cookie   -----------</li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#setCookie">setCookie</a></li><li><a href="global.html#clearCookie">clearCookie</a></li><li><a href="global.html#clearAll">clearAll</a></li><li class="nav-separator">------------   cos   ------------</li><li><a href="global.html#uploadCOSFile">uploadCOSFile</a></li><li class="nav-separator">------------   css   ------------</li><li><a href="global.html#removeCss">removeCss</a></li><li class="nav-separator">------------   date   ------------</li><li><a href="global.html#getMonthDay">getMonthDay</a></li><li><a href="global.html#getMonthDay2">getMonthDay2</a></li><li><a href="global.html#isSameWeek">isSameWeek</a></li><li><a href="global.html#timeStampFormat">timeStampFormat</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#parseTime">parseTime</a></li><li><a href="global.html#getTimeAgo">getTimeAgo</a></li><li><a href="global.html#getTimeAgoOrDate">getTimeAgoOrDate</a></li><li><a href="global.html#getCountDownObj">getCountDownObj</a></li><li><a href="global.html#getDayStartTimestamp">getDayStartTimestamp</a></li><li><a href="global.html#getDayEndTimeStamp">getDayEndTimeStamp</a></li><li class="nav-separator">------------   env   ------------</li><li><a href="global.html#checkUAIsIOS">checkUAIsIOS</a></li><li><a href="global.html#getEnvUAType">getEnvUAType</a></li><li class="nav-separator">------------   git   ------------</li><li><a href="global.html#getGitCurBranch">getGitCurBranch</a></li><li><a href="global.html#getGitCommitInfo">getGitCommitInfo</a></li><li><a href="global.html#getGitLastTag">getGitLastTag</a></li><li><a href="global.html#getGitCommitsBeforeTag">getGitCommitsBeforeTag</a></li><li><a href="global.html#getGitAuthor">getGitAuthor</a></li><li class="nav-separator">-----------   loader   -----------</li><li><a href="global.html#loadJS">loadJS</a></li><li><a href="global.html#loadCSS">loadCSS</a></li><li class="nav-separator">-----------   mp-ci   -----------</li><li><a href="global.html#parseUploadResult">parseUploadResult</a></li><li class="nav-separator">----------   node-img   ----------</li><li><a href="global.html#saveBase64ImgToFile">saveBase64ImgToFile</a></li><li><a href="global.html#turnLocalImg2Base64">turnLocalImg2Base64</a></li><li><a href="global.html#saveRemoteImgToLocal">saveRemoteImgToLocal</a></li><li><a href="global.html#getImgMd5">getImgMd5</a></li><li class="nav-separator">-----   open-source-report   -----</li><li><a href="global.html#sendOpenSourceReport">sendOpenSourceReport</a></li><li class="nav-separator">----------   pipeline   ----------</li><li><a href="global.html#startPipeline">startPipeline</a></li><li class="nav-separator">----------   rainbow   ----------</li><li><a href="global.html#addOrUpdateRainbowKV">addOrUpdateRainbowKV</a></li><li><a href="global.html#addRainbowKV">addRainbowKV</a></li><li><a href="global.html#updateRainbowKV">updateRainbowKV</a></li><li><a href="global.html#createRainbowPublishJob">createRainbowPublishJob</a></li><li><a href="global.html#publishRainbowTask">publishRainbowTask</a></li><li><a href="global.html#closeRainbowTask">closeRainbowTask</a></li><li><a href="global.html#updateRainbowKVAndPublish">updateRainbowKVAndPublish</a></li><li><a href="global.html#queryGroupInfo">queryGroupInfo</a></li><li><a href="global.html#fetchRainbowConfig">fetchRainbowConfig</a></li><li class="nav-separator">-------   rainbow-to-cos   -------</li><li><a href="global.html#watchRainbowToCosAndSendRobot">watchRainbowToCosAndSendRobot</a></li><li class="nav-separator">----------   tam/img   ----------</li><li><a href="global.html#genCustomEventImgAndSendRobot">genCustomEventImgAndSendRobot</a></li><li><a href="global.html#genMultiImgAndSendRobot">genMultiImgAndSendRobot</a></li><li><a href="global.html#genSummaryDataAndSendRobot">genSummaryDataAndSendRobot</a></li><li class="nav-separator">------------   tgit   ------------</li><li><a href="global.html#getBranchLifeCycle">getBranchLifeCycle</a></li><li><a href="global.html#getProjectDefaultBranch">getProjectDefaultBranch</a></li><li><a href="global.html#getBranchesByProjectName">getBranchesByProjectName</a></li><li><a href="global.html#getOneBranchDetail">getOneBranchDetail</a></li><li><a href="global.html#getOneCommitDetail">getOneCommitDetail</a></li><li><a href="global.html#createMR">createMR</a></li><li><a href="global.html#getMrList">getMrList</a></li><li><a href="global.html#getOneMrComments">getOneMrComments</a></li><li><a href="global.html#getOneProjectDetail">getOneProjectDetail</a></li><li><a href="global.html#getOneProjectBySearch">getOneProjectBySearch</a></li><li><a href="global.html#getAllProjects">getAllProjects</a></li><li><a href="global.html#deleteTGitProject">deleteTGitProject</a></li><li class="nav-separator">------------   url   ------------</li><li><a href="global.html#getQueryObj">getQueryObj</a></li><li><a href="global.html#composeUrlQuery">composeUrlQuery</a></li><li><a href="global.html#encodeUrlParam">encodeUrlParam</a></li><li><a href="global.html#decodeUrlParam">decodeUrlParam</a></li><li class="nav-separator">------------   util   ------------</li><li><a href="global.html#buildAndUpload">buildAndUpload</a></li><li><a href="global.html#readEnvVariable">readEnvVariable</a></li><li><a href="global.html#formatBite">formatBite</a></li><li><a href="global.html#innerCopyDir">innerCopyDir</a></li><li><a href="global.html#copyDir">copyDir</a></li><li><a href="global.html#deleteFolder">deleteFolder</a></li><li><a href="global.html#copyFile">copyFile</a></li><li><a href="global.html#traverseFolder">traverseFolder</a></li><li><a href="global.html#execCommand">execCommand</a></li><li><a href="global.html#writeEnvTokenToNpmRC">writeEnvTokenToNpmRC</a></li><li><a href="global.html#statisticsPages">statisticsPages</a></li><li><a href="global.html#statisticsComponent">statisticsComponent</a></li><li><a href="global.html#sleep">sleep</a></li><li class="nav-separator">----------   validate   ----------</li><li><a href="global.html#isIdCard">isIdCard</a></li><li><a href="global.html#isRegExp">isRegExp</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isExternal">isExternal</a></li><li><a href="global.html#validURL">validURL</a></li><li><a href="global.html#validLowerCase">validLowerCase</a></li><li><a href="global.html#validUpperCase">validUpperCase</a></li><li><a href="global.html#validAlphabets">validAlphabets</a></li><li><a href="global.html#validEmail">validEmail</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isQQNumber">isQQNumber</a></li><li><a href="global.html#isEmail">isEmail</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isTel">isTel</a></li><li class="nav-separator">--------   version-tip   --------</li><li><a href="global.html#genVersionAndSendChangeLog">genVersionAndSendChangeLog</a></li><li><a href="global.html#genVersionTip">genVersionTip</a></li><li><a href="global.html#genVersion">genVersion</a></li><li class="nav-separator">----------   weather   ----------</li><li><a href="global.html#fetchWeatherData">fetchWeatherData</a></li><li><a href="global.html#sendWeatherRobotMsg">sendWeatherRobotMsg</a></li><li><a href="global.html#getWeatherRobotContent">getWeatherRobotContent</a></li><li class="nav-separator">--------   wecom-robot   --------</li><li><a href="global.html#sendWxRobotMsg">sendWxRobotMsg</a></li><li><a href="global.html#sendWxRobotMarkdown">sendWxRobotMarkdown</a></li><li><a href="global.html#sendWxRobotImg">sendWxRobotImg</a></li><li><a href="global.html#batchSendWxRobotBase64Img">batchSendWxRobotBase64Img</a></li><li><a href="global.html#sendWxRobotBase64Img">sendWxRobotBase64Img</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">jsdoc/jsdoc.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable @typescript-eslint/no-require-imports */
import { timeStampFormat } from '../date/time';


const DEFAULT_EXTRA_CSS = `
.nav-separator {
  color: hsl(207, 1%, 60%);
  font-size: 12px;
  display: block;
}

nav ul a, nav ul a:active {
  font-size: 14px;
}
`;

function getSeparatorStr(content) {
  const maxLen = 14;
  const lastLen = parseInt(`${maxLen - (content.length) / 2}`, 10);
  const fill = Array.from({ length: lastLen })
    .map(() =&gt; '-')
    .join('');

  return `${fill}   ${content}   ${fill}`;
}

/**
 * 删除重复的部分
 * @ignore
 */
function deleteRepeatedSections($) {
  const sections = $('section');
  let last = '';
  sections.map((_, section) =&gt; {
    const html = $(section).html()
      .trim();
    if (html === last) {
      $(section).remove();
    } else {
      last = html;
    }
  });
  return $;
}

/**
 * 替换footer
 * @ignore
 * @param $ cheerio
 * @param author 作者
 */
function replaceFooter($, author) {
  const timezone = new Date().getTimezoneOffset() / -60;
  const footerContent = `Documentation generated on ${timeStampFormat(Date.now(), 'yyyy-MM-dd hh:mm:ss')} GMT+0${timezone}00 ${author &amp;&amp; ` by ${author}`}.`;
  $('footer').html(footerContent);
}


/**
 * 找到 Modules 下的导航列表
 * @ignore
 * @param $ cheerio
 */
function findModuleNav($) {
  const titles = $('body nav h3');
  let res;
  titles.map((_, title) =&gt; {
    if ($(title).html()
      .trim() === 'Modules') {
      res = $(title).next();
    }
  });
  return res;
}


/**
 * 获取nav头部，比如 tools/url =&gt; tools
 * @ignore
 */
function getNavPrefix(nav = '') {
  if (nav.indexOf('/') &lt; 0) {
    return '';
  }
  return nav.split('/')[0];
}

/**
 * 给 Modules 下的导航列表插入分隔符
 * @ignore
 * @param $ cheerio
 */
function insertModuleNavSeparator($) {
  const module = findModuleNav($);
  if (!module) return;

  let last = '';
  $(module).children('li')
    .map((_, li) =&gt; {
      const nav = $(li).children('a')
        ?.html()
        ?.trim();
      const prefix = getNavPrefix(nav);

      if (prefix &amp;&amp; last !== prefix) {
        $(li).before(`&lt;li class="nav-separator"&gt;${getSeparatorStr(prefix)}&lt;/li&gt;`);
      }

      if (prefix) {
        last = prefix;

        const navList = nav.split('/');
        $(li).children('a')
          .html(navList.slice(1).join('/'));
      }
    });
}


/**
 * 插入分隔符
 * @ignore
 */
function insertNavSeparator($, sourceMap) {
  const naves = $('nav &gt; ul li');
  let cur = '';

  naves.map((_, dom) =&gt; {
    const nav = $(dom).find('a')
      .attr('href')
      ?.trim();
    if (nav &amp;&amp; sourceMap[nav] &amp;&amp; cur !==  sourceMap[nav]) {
      $(dom).before(`&lt;li class="nav-separator"&gt;${sourceMap[nav]}&lt;/li&gt;`);
      cur =  sourceMap[nav];
    }
  });
}

/**
 * 插入script
 * @ignore
 */
function insertScript($, script = '') {
  if (!script) return;
  $('head').children()
    .last()
    .after(script);
}


/**
 * 默认处理source的方法，默认仅去掉的文件名
 * @ignore
 * @param source 文件路径
 * @returns 处理后的数据
 */
function defaultNavHandler(source) {
  const list = source.split('/');
  return list.slice(0, list.length - 1).join('/');
}


class JsDocHandler {
  /**
   * 初始化并运行
   * @static
   * @param {object} options 配置
   * @param {string} [options.docsPath] 文档所在目录位置，默认为`./docs`
   * @param {string} [options.author] 作者，默认为空
   * @param {string} [options.extraCss] 额外插入的css，默认为`.nav-separator`的一些样式
   * @param {string} [options.navHandler] 处理API所在文件的方法
   * @param {boolean} [options.isHandleNav] 是否处理导航栏，即插入文件名进行分隔，默认为false
   * @returns {object} JsDocHandler实例
   * @example
   *
   * JsDocHandler.init({
   *   author: 'novlan1',
   *   docsPath: './docs',
   *   extraCss: '.some-class{}',
   *   navHandler(nav) {
   *
   *   }
   * })
   *
   */
  static init(options) {
    const handler = new JsDocHandler(options);
    handler.run();
    return handler;
  }

  extraCss: string;
  extraScript: string;
  author: string;
  docsPath: string;
  navHandler: Function;
  isHandleNav: boolean;
  fs;
  path;

  /**
   * 处理jsdoc的脚本
   * 1. 增加导航栏的分隔符
   * 2. 增加css
   * 3. 处理footer
   * @constructor
   * @param {object} options 配置
   * @param {string} [options.docsPath] 文档所在目录位置，默认为`./docs`
   * @param {string} [options.author] 作者，默认为空
   * @param {string} [options.extraCss] 额外插入的css，默认为`.nav-separator`的一些样式
   * @param {string} [options.extraScript] 额外插入的script
   * @param {Function} [options.navHandler] 处理API所在文件的方法
   * @param {boolean} [options.isHandleNav] 是否处理导航栏，即插入文件名进行分隔，默认为false
   */
  constructor(options: {
    docsPath?: string
    author?: string
    extraCss?: string
    extraScript?: string
    navHandler?: Function
    isHandleNav?: boolean;
  } = {}) {
    const {
      docsPath = './docs',
      author =  '',
      extraCss = DEFAULT_EXTRA_CSS,
      extraScript = '',
      navHandler = defaultNavHandler,
      isHandleNav = false,
    } = options;

    this.docsPath = docsPath;
    this.author = author;
    this.extraCss = extraCss;
    this.extraScript = extraScript;
    this.navHandler = navHandler;
    this.isHandleNav = isHandleNav;
    this.fs = this.getFs();
    this.path = this.getPath();
  }

  run() {
    let sourceMap = {};
    if (this.isHandleNav) {
      sourceMap = this.getGlobalSourceMap();
    }
    this.handleEveryHtml(sourceMap, this.author);
    this.appendCSS(this.extraCss);
    this.finished();
  }

  getPath() {
    return require('path');
  }

  getFs() {
    return require('fs');
  }

  getGlobalSourceMap() {
    console.log('Parsing nav list of global.html ...');
    const file = 'global.html';
    const sourceMap = this.getSourceMap(file);
    return this.parseSourceMap(sourceMap);
  }

  /**
   * 获取sourceMap，形如：
   * ```ts
   * {
   *   NUMBER_CHI_MAP: 'base/number/number.ts',
   *   parseFunction: 'base/function/function.ts',
   *   flatten: 'base/list/list.ts',
   * }
   * ```
   * @private
   * @param {string} content
   * @return {object} sourceMap
   */
  getSourceMap(file) {
    const html = this.path.resolve(this.docsPath, file);
    const content = this.fs.readFileSync(html, {
      encoding: 'utf-8',
    });

    const cheerio = require('cheerio');
    const $ = cheerio.load(content);
    const sourceMap = {};
    const names = $('#main section article h4.name');

    names.map((_, dom) =&gt; {
      const id = $(dom).attr('id');
      let source = $(dom).next()
        .find('dd.tag-source ul.dummy li a')
        .html()
        .trim();

      source = this.navHandler(source);

      sourceMap[`${file}#${id}`] = source;
    });

    return sourceMap;
  }

  handleEveryHtml(sourceMap, author) {
    const files = this.fs.readdirSync(this.docsPath);
    files.forEach((file) =&gt; {
      if (file.endsWith('.html')) {
        const filePath =  this.path.resolve(this.docsPath, file);
        const content = this.fs.readFileSync(filePath, {
          encoding: 'utf-8',
        });
        const html = this.getParsedHtml(content, sourceMap, author);

        this.fs.writeFileSync(filePath, html, {
          encoding: 'utf-8',
        });
      }
    });
  }

  parseSourceMap(sourceMap) {
    return Object.keys(sourceMap).reduce((acc, key) =&gt; {
      const value = sourceMap[key];
      acc[key] = getSeparatorStr(value);
      return acc;
    }, {});
  }


  getParsedHtml(content, sourceMap, author) {
    const cheerio = require('cheerio');
    const $ = cheerio.load(content);
    const { extraScript } = this;

    // 删除重复selection
    deleteRepeatedSections($);

    // 插入分隔符
    insertNavSeparator($, sourceMap);

    // Modules下的导航栏插入分隔符
    insertModuleNavSeparator($);

    // 插入script
    insertScript($, extraScript);

    // 处理footer
    replaceFooter($, author);
    return $.html();
  }


  appendCSS(extra) {
    console.log('Appending extra css ...');

    const css = this.path.resolve(this.docsPath, 'styles/jsdoc.css');

    const content = this.fs.readFileSync(css, {
      encoding: 'utf-8',
    });

    this.fs.writeFileSync(css, `${content} \n${extra}`, {
      encoding: 'utf-8',
    });
  }

  finished() {
    console.log('Finished jsdoc local script.');
  }
}

export {
  JsDocHandler,
};

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>Documentation generated on 2023-03-08 07:51:05 GMT+0000  by novlan1.</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer=""></script>


<script src="scripts/collapse.js" defer=""></script>


    <script src="./jsdoc.js"></script>
    


</body></html>