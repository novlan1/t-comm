<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>rainbow/rainbow-admin.ts - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/novlan1/t-comm" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="MorsePwd.html">MorsePwd</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MorsePwd.html#.init">init</a></li><li data-type='method' style='display: none;'><a href="MorsePwd.html#clear">clear</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#parseFunction">parseFunction</a></li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#shuffle">shuffle</a></li><li><a href="global.html#isListAllEqual">isListAllEqual</a></li><li><a href="global.html#getKeyValuesMap">getKeyValuesMap</a></li><li><a href="global.html#getPreviousRatio">getPreviousRatio</a></li><li><a href="global.html#getMaxAndMinIdx">getMaxAndMinIdx</a></li><li><a href="global.html#flattenPreData">flattenPreData</a></li><li><a href="global.html#getUnitPreviousRatio">getUnitPreviousRatio</a></li><li><a href="global.html#NUMBER_CHI_MAP">NUMBER_CHI_MAP</a></li><li><a href="global.html#toHumpObj">toHumpObj</a></li><li><a href="global.html#toUnicodeAt">toUnicodeAt</a></li><li><a href="global.html#toUnicode">toUnicode</a></li><li><a href="global.html#mergeMultiCanvasPic">mergeMultiCanvasPic</a></li><li><a href="global.html#createCanvasTable">createCanvasTable</a></li><li><a href="global.html#getAreaData">getAreaData</a></li><li><a href="global.html#getAllAreaData">getAllAreaData</a></li><li><a href="global.html#getAreaCode">getAreaCode</a></li><li><a href="global.html#getProvName">getProvName</a></li><li><a href="global.html#getCityName">getCityName</a></li><li><a href="global.html#getAreaName">getAreaName</a></li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#setCookie">setCookie</a></li><li><a href="global.html#clearCookie">clearCookie</a></li><li><a href="global.html#clearAll">clearAll</a></li><li><a href="global.html#uploadCOSFile">uploadCOSFile</a></li><li><a href="global.html#removeCss">removeCss</a></li><li><a href="global.html#getMonthDay">getMonthDay</a></li><li><a href="global.html#getMonthDay2">getMonthDay2</a></li><li><a href="global.html#isSameWeek">isSameWeek</a></li><li><a href="global.html#timeStampFormat">timeStampFormat</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#parseTime">parseTime</a></li><li><a href="global.html#getTimeAgo">getTimeAgo</a></li><li><a href="global.html#getTimeAgoOrDate">getTimeAgoOrDate</a></li><li><a href="global.html#getCountDownObj">getCountDownObj</a></li><li><a href="global.html#getRealUA">getRealUA</a></li><li><a href="global.html#checkUAIsIOS">checkUAIsIOS</a></li><li><a href="global.html#getEnvUAType">getEnvUAType</a></li><li><a href="global.html#loadJS">loadJS</a></li><li><a href="global.html#loadCSS">loadCSS</a></li><li><a href="global.html#saveBase64ImgToFile">saveBase64ImgToFile</a></li><li><a href="global.html#turnLocalImg2Base64">turnLocalImg2Base64</a></li><li><a href="global.html#saveRemoteImgToLocal">saveRemoteImgToLocal</a></li><li><a href="global.html#getImgMd5">getImgMd5</a></li><li><a href="global.html#startPipeline">startPipeline</a></li><li><a href="global.html#addOrUpdateRainbowKV">addOrUpdateRainbowKV</a></li><li><a href="global.html#addRainbowKV">addRainbowKV</a></li><li><a href="global.html#updateRainbowKV">updateRainbowKV</a></li><li><a href="global.html#createRainbowPublishJob">createRainbowPublishJob</a></li><li><a href="global.html#publishRainbowTask">publishRainbowTask</a></li><li><a href="global.html#closeRainbowTask">closeRainbowTask</a></li><li><a href="global.html#updateRainbowKVAndPublish">updateRainbowKVAndPublish</a></li><li><a href="global.html#queryGroupInfo">queryGroupInfo</a></li><li><a href="global.html#fetchRainbowConfig">fetchRainbowConfig</a></li><li><a href="global.html#getBranchLifeCycle">getBranchLifeCycle</a></li><li><a href="global.html#getProjectDefaultBranch">getProjectDefaultBranch</a></li><li><a href="global.html#getBranchesByProjectName">getBranchesByProjectName</a></li><li><a href="global.html#getOneBranchDetail">getOneBranchDetail</a></li><li><a href="global.html#getOneCommitDetail">getOneCommitDetail</a></li><li><a href="global.html#createMR">createMR</a></li><li><a href="global.html#getMrList">getMrList</a></li><li><a href="global.html#getOneMrComments">getOneMrComments</a></li><li><a href="global.html#getOneProjectDetail">getOneProjectDetail</a></li><li><a href="global.html#getOneProjectBySearch">getOneProjectBySearch</a></li><li><a href="global.html#getAllProjects">getAllProjects</a></li><li><a href="global.html#getQueryObj">getQueryObj</a></li><li><a href="global.html#composeUrlQuery">composeUrlQuery</a></li><li><a href="global.html#encodeUrlParam">encodeUrlParam</a></li><li><a href="global.html#decodeUrlParam">decodeUrlParam</a></li><li><a href="global.html#isRegExp">isRegExp</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#cached">cached</a></li><li><a href="global.html#camelize">camelize</a></li><li><a href="global.html#hyphenate">hyphenate</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#titleize">titleize</a></li><li><a href="global.html#extend">extend</a></li><li><a href="global.html#getThousandSeparator">getThousandSeparator</a></li><li><a href="global.html#getThousandSeparator2">getThousandSeparator2</a></li><li><a href="global.html#getCommitInfo">getCommitInfo</a></li><li><a href="global.html#isExternal">isExternal</a></li><li><a href="global.html#validURL">validURL</a></li><li><a href="global.html#validLowerCase">validLowerCase</a></li><li><a href="global.html#validUpperCase">validUpperCase</a></li><li><a href="global.html#validAlphabets">validAlphabets</a></li><li><a href="global.html#validEmail">validEmail</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isQQNumber">isQQNumber</a></li><li><a href="global.html#isEmail">isEmail</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isTel">isTel</a></li><li><a href="global.html#isIdCard">isIdCard</a></li><li><a href="global.html#genVersionTip">genVersionTip</a></li><li><a href="global.html#genVersion">genVersion</a></li><li><a href="global.html#sendWxRobotMsg">sendWxRobotMsg</a></li><li><a href="global.html#sendWxRobotMarkdown">sendWxRobotMarkdown</a></li><li><a href="global.html#sendWxRobotImg">sendWxRobotImg</a></li><li><a href="global.html#sendWxRobotBase64Img">sendWxRobotBase64Img</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">rainbow/rainbow-admin.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { baseRequestRainbow } from './helper/rainbow-base-request';
import { getVersion } from './helper/helper';
import { SecretInfo, ValueType, ModifyConfigParam } from './index.type';

/**
 * 添加或更新配置
 *
 * @param {object} config 配置信息
 * @param {object} config.keyValue 配置对象
 * @param {string} config.keyValue.key 配置的key
 * @param {string} config.keyValue.value 配置的value
 * @param {string} config.valueType 配置类型，1: NUMBER, 2: STRING, 3: TEXT, 4: JSON, 5: XML, 18: 日期, 20: yaml
 * @param {SecretInfo} config.secretInfo 密钥信息
 * @param {string} config.secretInfo.appId 项目ID
 * @param {string} config.secretInfo.userId 用户ID
 * @param {string} config.secretInfo.secretKey 密钥
 * @param {string} config.secretInfo.envName 配置环境
 * @param {string} config.secretInfo.groupName 配置组
 * @returns {Promise&lt;object>} 请求Promise
 *
 * @example
 * addOrUpdateRainbowKV({
 *   keyValue: {
 *     key: 'theKey',
 *     value: 'theValue',
 *   },
 *   valueType: 2,
 *   secretInfo: {
 *     appId: 'xxx',
 *     userId: 'xxx',
 *     secretKey: 'xxx',
 *     envName: 'prod',
 *     groupName: 'xxx',
 *   }
 * }).then(() => {
 *
 * })
 */
export function addOrUpdateRainbowKV({
  keyValue,
  valueType = 2,
  secretInfo,
}: ModifyConfigParam): Promise&lt;object> {
  return baseRequestRainbow({
    url: '/adminapi.Config/ChangeKeyReq',
    data: {
      is_sync: false,
      key_values: [
        {
          value_type: valueType,
          config_op_type: 4,
          description: '',
          ...keyValue,
        },
      ],
    },
    secretInfo,
  });
}

/**
 * 增加配置
 *
 * @param config 配置信息
 * @returns 请求Promise
 */
export function addRainbowKV({
  keyValue,
  valueType = 2,
  secretInfo,
}: ModifyConfigParam) {
  return baseRequestRainbow({
    url: '/adminapi.Config/ChangeKeyReq',
    data: {
      is_sync: false,
      key_values: [
        {
          value_type: valueType,
          config_op_type: 2,
          description: '',
          ...keyValue,
        },
      ],
    },
    secretInfo,
  });
}

/**
 * 修改配置
 *
 * @param config - 配置信息
 * @returns 请求Promise
 */
export function updateRainbowKV({
  keyValue,
  valueType = 2,
  secretInfo,
}: ModifyConfigParam) {
  return baseRequestRainbow({
    url: '/adminapi.Config/ChangeKeyReq',
    data: {
      is_sync: false,
      key_values: [
        {
          value_type: valueType, // 1:NUMBER, 2:STRING,3:TEXT,4:JSON,5:XML,18:日期,20：yaml
          config_op_type: 1,
          description: '',
          ...keyValue,
        },
      ],
    },
    secretInfo,
  });
}

/**
 * 创建发布任务
 *
 * @param obj - 配置信息
 * @returns 请求Promise
 */
export function createRainbowPublishJob({ versionName, secretInfo }) {
  return baseRequestRainbow({
    url: '/adminapi.Config/CreateReleaseTaskReq',
    data: {
      creator: 'guowangyang',
      approvers: 'guowangyang',
      version_name: versionName,
      type: 0,
    },
    secretInfo,
  });
}

/**
 * 发布任务
 *
 * @param obj - 配置信息
 * @returns 请求Promise
 */
export function publishRainbowTask({ taskId, secretInfo }) {
  return baseRequestRainbow({
    url: '/adminapi.Release/ReleaseMainTaskReq',
    data: {
      task_id: taskId,
    },
    secretInfo,
  });
}

/**
 * 关闭任务
 *
 * @param obj - 配置信息
 * @returns 请求Promise
 */
export function closeRainbowTask({ taskId, secretInfo }) {
  return baseRequestRainbow({
    url: '/adminapi.Release/CloseReleaseTaskReq',
    data: {
      task_id: taskId,
    },
    secretInfo,
  });
}

/**
 * 修改值并发布
 *
 * @param obj 配置信息
 */
export async function updateRainbowKVAndPublish({
  key,
  value,
  valueType,
  secretInfo,
}: {
  key: string
  value: string
  valueType: ValueType
  secretInfo: SecretInfo
}) {
  try {
    await addOrUpdateRainbowKV({
      keyValue: {
        key,
        value,
      },
      valueType,
      secretInfo,
    });
    const taskRes: any = await createRainbowPublishJob({
      versionName: getVersion(),
      secretInfo,
    });
    await publishRainbowTask({
      taskId: taskRes.task_id,
      secretInfo,
    });
    await closeRainbowTask({
      taskId: taskRes.task_id,
      secretInfo,
    });
    return taskRes;
  } catch (err) {
    return Promise.reject(err);
  }
}

/**
 * 查询分组配置
 * @param {object} config 配置信息
 * @returns {Promise&lt;Array&lt;object>>} 分组配置
 */
export function queryGroupInfo({ secretInfo }) {
  return new Promise((resolve, reject) => {
    baseRequestRainbow({
      url: '/adminapi.Config/QueryGroupInfoReq',
      data: {},
      secretInfo,
    })
      .then((res: any) => {
        const keyValues = res.config_infos?.[0]?.key_values || [];
        resolve(keyValues);
      })
      .catch((err) => {
        reject(err);
      });
  });
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


    <script src="./jsdoc.js"></script>
    
</body>
</html>
