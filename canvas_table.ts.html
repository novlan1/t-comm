<!DOCTYPE html><html lang="en"><head>
    
    <meta charset="utf-8">
    <title>canvas/table.ts - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
console.log('Hello!')
  
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger">
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search">
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/novlan1/t-comm" target="_blank" class="menu-item" id="repository">Github repo</a></h2><h3>Classes</h3><ul><li><a href="JsDocHandler.html">JsDocHandler</a><ul class="methods"><li data-type="method" style="display: none;"><a href="JsDocHandler.html#.init">init</a></li></ul></li><li><a href="MorsePwd.html">MorsePwd</a><ul class="methods"><li data-type="method" style="display: none;"><a href="MorsePwd.html#.init">init</a></li><li data-type="method" style="display: none;"><a href="MorsePwd.html#clear">clear</a></li></ul></li><li><a href="MpCI_MpCI.html">MpCI#MpCI</a></li></ul><h3>Global</h3><ul><li class="nav-separator">-------   base/function   -------</li><li><a href="global.html#parseFunction">parseFunction</a></li><li><a href="global.html#cached">cached</a></li><li class="nav-separator">---------   base/list   ---------</li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#shuffle">shuffle</a></li><li><a href="global.html#getAccCellWidth">getAccCellWidth</a></li><li><a href="global.html#isListAllEqual">isListAllEqual</a></li><li><a href="global.html#getKeyValuesMap">getKeyValuesMap</a></li><li><a href="global.html#getPreviousRatio">getPreviousRatio</a></li><li><a href="global.html#getMaxAndMinIdx">getMaxAndMinIdx</a></li><li><a href="global.html#flattenPreData">flattenPreData</a></li><li><a href="global.html#compareTwoList">compareTwoList</a></li><li class="nav-separator">--------   base/number   --------</li><li><a href="global.html#getUnitPreviousRatio">getUnitPreviousRatio</a></li><li><a href="global.html#getPartRatio">getPartRatio</a></li><li><a href="global.html#NUMBER_CHI_MAP">NUMBER_CHI_MAP</a></li><li><a href="global.html#getThousandSeparator">getThousandSeparator</a></li><li><a href="global.html#getThousandSeparator2">getThousandSeparator2</a></li><li class="nav-separator">--------   base/object   --------</li><li><a href="global.html#toHumpObj">toHumpObj</a></li><li><a href="global.html#extend">extend</a></li><li class="nav-separator">--------   base/string   --------</li><li><a href="global.html#camelize">camelize</a></li><li><a href="global.html#hyphenate">hyphenate</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#titleize">titleize</a></li><li><a href="global.html#lowerInitial">lowerInitial</a></li><li><a href="global.html#toUnicodeAt">toUnicodeAt</a></li><li><a href="global.html#toUnicode">toUnicode</a></li><li class="nav-separator">-----------   canvas   -----------</li><li><a href="global.html#addTextForImg">addTextForImg</a></li><li><a href="global.html#mergeMultiCanvasPic">mergeMultiCanvasPic</a></li><li><a href="global.html#createCanvasTable">createCanvasTable</a></li><li class="nav-separator">------------   city   ------------</li><li><a href="global.html#getAreaData">getAreaData</a></li><li><a href="global.html#getAllAreaData">getAllAreaData</a></li><li><a href="global.html#getAreaCode">getAreaCode</a></li><li><a href="global.html#getProvName">getProvName</a></li><li><a href="global.html#getCityName">getCityName</a></li><li><a href="global.html#getAreaName">getAreaName</a></li><li class="nav-separator">-----------   cookie   -----------</li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#setCookie">setCookie</a></li><li><a href="global.html#clearCookie">clearCookie</a></li><li><a href="global.html#clearAll">clearAll</a></li><li class="nav-separator">------------   cos   ------------</li><li><a href="global.html#uploadCOSFile">uploadCOSFile</a></li><li class="nav-separator">------------   css   ------------</li><li><a href="global.html#removeCss">removeCss</a></li><li class="nav-separator">------------   date   ------------</li><li><a href="global.html#getMonthDay">getMonthDay</a></li><li><a href="global.html#getMonthDay2">getMonthDay2</a></li><li><a href="global.html#isSameWeek">isSameWeek</a></li><li><a href="global.html#timeStampFormat">timeStampFormat</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#parseTime">parseTime</a></li><li><a href="global.html#getTimeAgo">getTimeAgo</a></li><li><a href="global.html#getTimeAgoOrDate">getTimeAgoOrDate</a></li><li><a href="global.html#getCountDownObj">getCountDownObj</a></li><li><a href="global.html#getDayStartTimestamp">getDayStartTimestamp</a></li><li><a href="global.html#getDayEndTimeStamp">getDayEndTimeStamp</a></li><li class="nav-separator">------------   env   ------------</li><li><a href="global.html#checkUAIsIOS">checkUAIsIOS</a></li><li><a href="global.html#getEnvUAType">getEnvUAType</a></li><li class="nav-separator">------------   git   ------------</li><li><a href="global.html#getGitCurBranch">getGitCurBranch</a></li><li><a href="global.html#getGitCommitInfo">getGitCommitInfo</a></li><li><a href="global.html#getGitLastTag">getGitLastTag</a></li><li><a href="global.html#getGitCommitsBeforeTag">getGitCommitsBeforeTag</a></li><li><a href="global.html#getGitAuthor">getGitAuthor</a></li><li class="nav-separator">-----------   loader   -----------</li><li><a href="global.html#loadJS">loadJS</a></li><li><a href="global.html#loadCSS">loadCSS</a></li><li class="nav-separator">----------   node-img   ----------</li><li><a href="global.html#saveBase64ImgToFile">saveBase64ImgToFile</a></li><li><a href="global.html#turnLocalImg2Base64">turnLocalImg2Base64</a></li><li><a href="global.html#saveRemoteImgToLocal">saveRemoteImgToLocal</a></li><li><a href="global.html#getImgMd5">getImgMd5</a></li><li class="nav-separator">-----   open-source-report   -----</li><li><a href="global.html#sendOpenSourceReport">sendOpenSourceReport</a></li><li class="nav-separator">----------   pipeline   ----------</li><li><a href="global.html#startPipeline">startPipeline</a></li><li class="nav-separator">----------   rainbow   ----------</li><li><a href="global.html#addOrUpdateRainbowKV">addOrUpdateRainbowKV</a></li><li><a href="global.html#addRainbowKV">addRainbowKV</a></li><li><a href="global.html#updateRainbowKV">updateRainbowKV</a></li><li><a href="global.html#createRainbowPublishJob">createRainbowPublishJob</a></li><li><a href="global.html#publishRainbowTask">publishRainbowTask</a></li><li><a href="global.html#closeRainbowTask">closeRainbowTask</a></li><li><a href="global.html#updateRainbowKVAndPublish">updateRainbowKVAndPublish</a></li><li><a href="global.html#queryGroupInfo">queryGroupInfo</a></li><li><a href="global.html#fetchRainbowConfig">fetchRainbowConfig</a></li><li class="nav-separator">-------   rainbow-to-cos   -------</li><li><a href="global.html#watchRainbowToCosAndSendRobot">watchRainbowToCosAndSendRobot</a></li><li class="nav-separator">----------   tam/img   ----------</li><li><a href="global.html#genCustomEventImgAndSendRobot">genCustomEventImgAndSendRobot</a></li><li><a href="global.html#genMultiImgAndSendRobot">genMultiImgAndSendRobot</a></li><li><a href="global.html#genSummaryDataAndSendRobot">genSummaryDataAndSendRobot</a></li><li class="nav-separator">------------   tgit   ------------</li><li><a href="global.html#getBranchLifeCycle">getBranchLifeCycle</a></li><li><a href="global.html#getProjectDefaultBranch">getProjectDefaultBranch</a></li><li><a href="global.html#getBranchesByProjectName">getBranchesByProjectName</a></li><li><a href="global.html#getOneBranchDetail">getOneBranchDetail</a></li><li><a href="global.html#getOneCommitDetail">getOneCommitDetail</a></li><li><a href="global.html#createMR">createMR</a></li><li><a href="global.html#getMrList">getMrList</a></li><li><a href="global.html#getOneMrComments">getOneMrComments</a></li><li><a href="global.html#getOneProjectDetail">getOneProjectDetail</a></li><li><a href="global.html#getOneProjectBySearch">getOneProjectBySearch</a></li><li><a href="global.html#getAllProjects">getAllProjects</a></li><li class="nav-separator">------------   url   ------------</li><li><a href="global.html#getQueryObj">getQueryObj</a></li><li><a href="global.html#composeUrlQuery">composeUrlQuery</a></li><li><a href="global.html#encodeUrlParam">encodeUrlParam</a></li><li><a href="global.html#decodeUrlParam">decodeUrlParam</a></li><li class="nav-separator">------------   util   ------------</li><li><a href="global.html#buildAndUpload">buildAndUpload</a></li><li><a href="global.html#readEnvVariable">readEnvVariable</a></li><li><a href="global.html#execCommand">execCommand</a></li><li><a href="global.html#writeEnvTokenToNpmRC">writeEnvTokenToNpmRC</a></li><li class="nav-separator">----------   validate   ----------</li><li><a href="global.html#isIdCard">isIdCard</a></li><li><a href="global.html#isRegExp">isRegExp</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isExternal">isExternal</a></li><li><a href="global.html#validURL">validURL</a></li><li><a href="global.html#validLowerCase">validLowerCase</a></li><li><a href="global.html#validUpperCase">validUpperCase</a></li><li><a href="global.html#validAlphabets">validAlphabets</a></li><li><a href="global.html#validEmail">validEmail</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isQQNumber">isQQNumber</a></li><li><a href="global.html#isEmail">isEmail</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isTel">isTel</a></li><li class="nav-separator">--------   version-tip   --------</li><li><a href="global.html#genVersionAndSendChangeLog">genVersionAndSendChangeLog</a></li><li><a href="global.html#genVersionTip">genVersionTip</a></li><li><a href="global.html#genVersion">genVersion</a></li><li class="nav-separator">----------   weather   ----------</li><li><a href="global.html#fetchWeatherData">fetchWeatherData</a></li><li><a href="global.html#sendWeatherRobotMsg">sendWeatherRobotMsg</a></li><li><a href="global.html#getWeatherRobotContent">getWeatherRobotContent</a></li><li class="nav-separator">--------   wecom-robot   --------</li><li><a href="global.html#sendWxRobotMsg">sendWxRobotMsg</a></li><li><a href="global.html#sendWxRobotMarkdown">sendWxRobotMarkdown</a></li><li><a href="global.html#sendWxRobotImg">sendWxRobotImg</a></li><li><a href="global.html#batchSendWxRobotBase64Img">batchSendWxRobotBase64Img</a></li><li><a href="global.html#sendWxRobotBase64Img">sendWxRobotBase64Img</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">canvas/table.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable @typescript-eslint/no-require-imports */
import { getAccCellWidth as oriGetAccCellWidth } from '../base/list';

const cellHeight = 20;
const extraHeight = 15;
const extraBottom = 10;
const extraWidth = 3;
const maxColor = '#fc5531';
const minColor = 'green';

function parseCellValue(val) {
  if (val === undefined || val === null) return '';
  return val;
}

/**
 * 判断是否有比例，只要一行有比例，即为有
 * @ignore
 */
function judgeRatio(data, value) {
  return !!(data || []).find((item) =&gt; {
    const values = Object.values(item) || [];
    return values.find(value =&gt; !!(value as any).ratio);
  }) &amp;&amp; !isNaN(value);
}

/**
 * 创建canvas的table
 * @param {object} config 输入配置
 * @param {Array&lt;object&gt;} config.data 输入数据
 * @param {Array&lt;string&gt;} config.headers 表头列表
 * @param {Array&lt;number&gt;} config.cellWidthList 每一格的宽度列表
 * @param {string} config.title 标题
 * @returns {string} 图片url
 * @example
 *
 * const tableData = [
 *   {
 *     ProjectName: { name: 'ProjectName', value: 'ProjectA' },
 *     ALL_SUMMARY: {
 *       name: 'ALL_SUMMARY',
 *       value: 4987,
 *       ratio: '+26.2%',
 *       previousValue: 3953,
 *       idx: 0,
 *       lastIdx: 0,
 *       isMax: true,
 *       isMin: false,
 *       isSecondMax: false,
 *       isSecondMin: false,
 *     },
 *     ALL_FAIL: {
 *       // ...
 *     },
 *   },
 *   {
 *     ProjectName: { name: 'ProjectName', value: 'ProjectB' },
 *     // ...
 *   },
 * ];
 *
 * createCanvasTable({
 *   data: tableData,
 *   headers: getHeaders(tableData),
 *   title: `007日报 ${date}`,
 *   cellWidthList: [
 *     95,
 *     65,
 *     65,
 *     65,
 *   ],
 * });
 */
export function createCanvasTable({
  data,
  headers,
  cellWidthList,
  title,
}: {
  data: Array&lt;object&gt;
  headers: Array&lt;string&gt;
  cellWidthList: Array&lt;number&gt;
  title: string
}): string {
  const { createCanvas } = require('canvas');
  const getAccCellWidth = oriGetAccCellWidth.bind(null, cellWidthList);

  const width = getAccCellWidth(headers.length - 1) * 2 + extraWidth * 4;
  const height = (data.length + 1) * cellHeight * 2 + extraHeight * 2 + extraBottom;

  const canvas = createCanvas(width, height);
  const ctx = canvas.getContext('2d');

  function fillBackground() {
    ctx.font = '7px Arial';
    ctx.scale(2, 2);
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  function fillTitle() {
    ctx.lineWidth = 1;
    ctx.strokeStyle = '#ccc';
    ctx.textAlign = 'start';
    ctx.font = '9px Arial';
    ctx.fillStyle = '#000';
    ctx.fillText(parseCellValue(title), 5, 10);
  }

  // 表头绘制
  function fillTableHeader() {
    ctx.font = '7px Arial';
    ctx.textAlign = 'center';
    const colors = [
      '#000000',
      '#000000',
      '#ff0000',
      '#006fff',
      '#07c160',
      '#ff0000',
      '#006fff',
    ];

    for (let i = 0; i &lt; headers.length; i++) {
      const cellWidth = cellWidthList[i];

      ctx.fillStyle = colors[0];
      ctx.moveTo(
        Math.round(cellWidth / 2) + getAccCellWidth(i - 1) + extraWidth,
        0,
      );
      ctx.fillText(
        parseCellValue(headers[i]),
        Math.round(cellWidth / 2) + getAccCellWidth(i - 1) + extraWidth,
        13.5 + extraHeight,
      );
    }
  }

  // 文字
  function fillCellText() {
    for (let i = 0; i &lt; data.length; i++) {
      Object.keys(data[i]).forEach((item, idx) =&gt; {
        let color;
        const obj = data[i][item];

        if (obj.isMax || obj.isSecondMax) {
          color = maxColor;
        } else if (obj.isMin || obj.isSecondMin) {
          color = minColor;
        } else {
          color = '#000000';
        }

        const cellWidth = cellWidthList[idx];
        const textWidth = Math.round(cellWidth / 2) + getAccCellWidth(idx - 1) + extraWidth;
        const textHeight = cellHeight * i + 33.5 + extraHeight;

        // 少了序号，颜色值后移
        ctx.fillStyle = color;

        const hasRatio = judgeRatio(data, obj.value);
        console.log('hasRatio', hasRatio, obj);

        if (!hasRatio) {
          ctx.fillText(`${parseCellValue(obj.value)}`, textWidth, textHeight);
        } else if (obj.ratio) {
          ctx.fillText(`${parseCellValue(obj.value)}       `, textWidth, textHeight);

          ctx.font = '5px Arial';
          ctx.textAlign = 'right';
          ctx.fillStyle = 'rgba(0,0,0,0.8)';

          // 绘制趋势
          ctx.fillText(parseCellValue(obj.ratio), textWidth + 30, textHeight);

          ctx.font = '7px Arial';
          ctx.textAlign = 'center';
        } else {
          ctx.fillText(`${parseCellValue(obj.value)}       `, textWidth, textHeight);
        }
      });
    }
  }

  // 画线
  function drawLine() {
    // 竖线
    for (let i = 0; i &lt; headers.length + 1; i++) {
      ctx.moveTo(getAccCellWidth(i - 1) + extraWidth, 0 + extraHeight);
      ctx.lineTo(
        getAccCellWidth(i - 1) + extraWidth,
        canvas.height / 2 - extraBottom / 2,
      );
    }

    // 横线
    for (let i = 0; i &lt; data.length + 2; i++) {
      ctx.moveTo(0 + extraWidth, cellHeight * i + extraHeight);
      ctx.lineTo(canvas.width / 2 - extraWidth, cellHeight * i + extraHeight);
    }
    ctx.stroke();
  }

  fillBackground();
  fillTitle();
  fillTableHeader();
  fillCellText();
  drawLine();

  const imgUrl = canvas.toDataURL();
  return imgUrl;
}

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>Documentation generated on 2022-10-21 12:07:02 GMT+0000  by novlan1.</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer=""></script>


<script src="scripts/collapse.js" defer=""></script>


    <script src="./jsdoc.js"></script>
    


</body></html>