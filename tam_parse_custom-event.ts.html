<!DOCTYPE html><html lang="en"><head>
    
    <meta charset="utf-8">
    <title>tam/parse/custom-event.ts - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
console.log('Hello!')
  
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger">
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search">
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/novlan1/t-comm" target="_blank" class="menu-item" id="repository">Github repo</a></h2><h3>Classes</h3><ul><li><a href="JsDocHandler.html">JsDocHandler</a><ul class="methods"><li data-type="method" style="display: none;"><a href="JsDocHandler.html#.init">init</a></li></ul></li><li><a href="MorsePwd.html">MorsePwd</a><ul class="methods"><li data-type="method" style="display: none;"><a href="MorsePwd.html#.init">init</a></li><li data-type="method" style="display: none;"><a href="MorsePwd.html#clear">clear</a></li></ul></li></ul><h3>Global</h3><ul><li class="nav-separator">-------   base/function   -------</li><li><a href="global.html#parseFunction">parseFunction</a></li><li><a href="global.html#cached">cached</a></li><li class="nav-separator">---------   base/list   ---------</li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#shuffle">shuffle</a></li><li><a href="global.html#getAccCellWidth">getAccCellWidth</a></li><li><a href="global.html#isListAllEqual">isListAllEqual</a></li><li><a href="global.html#getKeyValuesMap">getKeyValuesMap</a></li><li><a href="global.html#getPreviousRatio">getPreviousRatio</a></li><li><a href="global.html#getMaxAndMinIdx">getMaxAndMinIdx</a></li><li><a href="global.html#flattenPreData">flattenPreData</a></li><li><a href="global.html#compareTwoList">compareTwoList</a></li><li class="nav-separator">--------   base/number   --------</li><li><a href="global.html#getUnitPreviousRatio">getUnitPreviousRatio</a></li><li><a href="global.html#getPartRatio">getPartRatio</a></li><li><a href="global.html#NUMBER_CHI_MAP">NUMBER_CHI_MAP</a></li><li><a href="global.html#getThousandSeparator">getThousandSeparator</a></li><li><a href="global.html#getThousandSeparator2">getThousandSeparator2</a></li><li class="nav-separator">--------   base/object   --------</li><li><a href="global.html#toHumpObj">toHumpObj</a></li><li><a href="global.html#extend">extend</a></li><li class="nav-separator">--------   base/string   --------</li><li><a href="global.html#camelize">camelize</a></li><li><a href="global.html#hyphenate">hyphenate</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#titleize">titleize</a></li><li><a href="global.html#lowerInitial">lowerInitial</a></li><li><a href="global.html#toUnicodeAt">toUnicodeAt</a></li><li><a href="global.html#toUnicode">toUnicode</a></li><li class="nav-separator">-----------   canvas   -----------</li><li><a href="global.html#mergeMultiCanvasPic">mergeMultiCanvasPic</a></li><li><a href="global.html#createCanvasTable">createCanvasTable</a></li><li class="nav-separator">------------   city   ------------</li><li><a href="global.html#getAreaData">getAreaData</a></li><li><a href="global.html#getAllAreaData">getAllAreaData</a></li><li><a href="global.html#getAreaCode">getAreaCode</a></li><li><a href="global.html#getProvName">getProvName</a></li><li><a href="global.html#getCityName">getCityName</a></li><li><a href="global.html#getAreaName">getAreaName</a></li><li class="nav-separator">-----------   cookie   -----------</li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#setCookie">setCookie</a></li><li><a href="global.html#clearCookie">clearCookie</a></li><li><a href="global.html#clearAll">clearAll</a></li><li class="nav-separator">------------   cos   ------------</li><li><a href="global.html#uploadCOSFile">uploadCOSFile</a></li><li class="nav-separator">------------   css   ------------</li><li><a href="global.html#removeCss">removeCss</a></li><li class="nav-separator">------------   date   ------------</li><li><a href="global.html#getMonthDay">getMonthDay</a></li><li><a href="global.html#getMonthDay2">getMonthDay2</a></li><li><a href="global.html#isSameWeek">isSameWeek</a></li><li><a href="global.html#timeStampFormat">timeStampFormat</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#parseTime">parseTime</a></li><li><a href="global.html#getTimeAgo">getTimeAgo</a></li><li><a href="global.html#getTimeAgoOrDate">getTimeAgoOrDate</a></li><li><a href="global.html#getCountDownObj">getCountDownObj</a></li><li><a href="global.html#getDayStartTimestamp">getDayStartTimestamp</a></li><li><a href="global.html#getDayEndTimeStamp">getDayEndTimeStamp</a></li><li class="nav-separator">------------   env   ------------</li><li><a href="global.html#checkUAIsIOS">checkUAIsIOS</a></li><li><a href="global.html#getEnvUAType">getEnvUAType</a></li><li class="nav-separator">------------   git   ------------</li><li><a href="global.html#getGitCurBranch">getGitCurBranch</a></li><li><a href="global.html#getGitCommitInfo">getGitCommitInfo</a></li><li><a href="global.html#getGitLastTag">getGitLastTag</a></li><li><a href="global.html#getGitCommitsBeforeTag">getGitCommitsBeforeTag</a></li><li><a href="global.html#getGitAuthor">getGitAuthor</a></li><li class="nav-separator">-----------   jsdoc   -----------</li><li><a href="global.html#insertModuleNavSeparator">insertModuleNavSeparator</a></li><li class="nav-separator">-----------   loader   -----------</li><li><a href="global.html#loadJS">loadJS</a></li><li><a href="global.html#loadCSS">loadCSS</a></li><li class="nav-separator">----------   node-img   ----------</li><li><a href="global.html#saveBase64ImgToFile">saveBase64ImgToFile</a></li><li><a href="global.html#turnLocalImg2Base64">turnLocalImg2Base64</a></li><li><a href="global.html#saveRemoteImgToLocal">saveRemoteImgToLocal</a></li><li><a href="global.html#getImgMd5">getImgMd5</a></li><li class="nav-separator">-----   open-source-report   -----</li><li><a href="global.html#sendOpenSourceReport">sendOpenSourceReport</a></li><li class="nav-separator">----------   pipeline   ----------</li><li><a href="global.html#startPipeline">startPipeline</a></li><li class="nav-separator">----------   rainbow   ----------</li><li><a href="global.html#addOrUpdateRainbowKV">addOrUpdateRainbowKV</a></li><li><a href="global.html#addRainbowKV">addRainbowKV</a></li><li><a href="global.html#updateRainbowKV">updateRainbowKV</a></li><li><a href="global.html#createRainbowPublishJob">createRainbowPublishJob</a></li><li><a href="global.html#publishRainbowTask">publishRainbowTask</a></li><li><a href="global.html#closeRainbowTask">closeRainbowTask</a></li><li><a href="global.html#updateRainbowKVAndPublish">updateRainbowKVAndPublish</a></li><li><a href="global.html#queryGroupInfo">queryGroupInfo</a></li><li><a href="global.html#fetchRainbowConfig">fetchRainbowConfig</a></li><li class="nav-separator">----------   tam/api   ----------</li><li><a href="global.html#getCustomEventData">getCustomEventData</a></li><li><a href="global.html#getMultiCustomEventData">getMultiCustomEventData</a></li><li><a href="global.html#getSummaryScoreByGroupIdList">getSummaryScoreByGroupIdList</a></li><li class="nav-separator">----------   tam/img   ----------</li><li><a href="global.html#genCustomEventImg">genCustomEventImg</a></li><li><a href="global.html#genCustomEventImgAndSendRobot">genCustomEventImgAndSendRobot</a></li><li><a href="global.html#genSummaryData">genSummaryData</a></li><li><a href="global.html#genSummaryDataAndSendRobot">genSummaryDataAndSendRobot</a></li><li class="nav-separator">---------   tam/parse   ---------</li><li><a href="global.html#getExtraEventData">getExtraEventData</a></li><li><a href="global.html#parseExtraData">parseExtraData</a></li><li><a href="global.html#parseMultiCustomEvent">parseMultiCustomEvent</a></li><li><a href="global.html#getTableHeaders">getTableHeaders</a></li><li><a href="global.html#parseSummaryScore">parseSummaryScore</a></li><li class="nav-separator">------------   tgit   ------------</li><li><a href="global.html#getBranchLifeCycle">getBranchLifeCycle</a></li><li><a href="global.html#getProjectDefaultBranch">getProjectDefaultBranch</a></li><li><a href="global.html#getBranchesByProjectName">getBranchesByProjectName</a></li><li><a href="global.html#getOneBranchDetail">getOneBranchDetail</a></li><li><a href="global.html#getOneCommitDetail">getOneCommitDetail</a></li><li><a href="global.html#createMR">createMR</a></li><li><a href="global.html#getMrList">getMrList</a></li><li><a href="global.html#getOneMrComments">getOneMrComments</a></li><li><a href="global.html#getOneProjectDetail">getOneProjectDetail</a></li><li><a href="global.html#getOneProjectBySearch">getOneProjectBySearch</a></li><li><a href="global.html#getAllProjects">getAllProjects</a></li><li class="nav-separator">------------   url   ------------</li><li><a href="global.html#getQueryObj">getQueryObj</a></li><li><a href="global.html#composeUrlQuery">composeUrlQuery</a></li><li><a href="global.html#encodeUrlParam">encodeUrlParam</a></li><li><a href="global.html#decodeUrlParam">decodeUrlParam</a></li><li class="nav-separator">------------   util   ------------</li><li><a href="global.html#buildAndUpload">buildAndUpload</a></li><li><a href="global.html#readEnvVariable">readEnvVariable</a></li><li><a href="global.html#execCommand">execCommand</a></li><li><a href="global.html#writeEnvTokenToNpmRC">writeEnvTokenToNpmRC</a></li><li class="nav-separator">----------   validate   ----------</li><li><a href="global.html#isIdCard">isIdCard</a></li><li><a href="global.html#isRegExp">isRegExp</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isExternal">isExternal</a></li><li><a href="global.html#validURL">validURL</a></li><li><a href="global.html#validLowerCase">validLowerCase</a></li><li><a href="global.html#validUpperCase">validUpperCase</a></li><li><a href="global.html#validAlphabets">validAlphabets</a></li><li><a href="global.html#validEmail">validEmail</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isQQNumber">isQQNumber</a></li><li><a href="global.html#isEmail">isEmail</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isTel">isTel</a></li><li class="nav-separator">--------   version-tip   --------</li><li><a href="global.html#genVersionAndSendChangeLog">genVersionAndSendChangeLog</a></li><li><a href="global.html#genVersionTip">genVersionTip</a></li><li><a href="global.html#genVersion">genVersion</a></li><li class="nav-separator">----------   weather   ----------</li><li><a href="global.html#fetchWeatherData">fetchWeatherData</a></li><li><a href="global.html#sendWeatherRobotMsg">sendWeatherRobotMsg</a></li><li><a href="global.html#getWeatherRobotContent">getWeatherRobotContent</a></li><li class="nav-separator">--------   wecom-robot   --------</li><li><a href="global.html#sendWxRobotMsg">sendWxRobotMsg</a></li><li><a href="global.html#sendWxRobotMarkdown">sendWxRobotMarkdown</a></li><li><a href="global.html#sendWxRobotImg">sendWxRobotImg</a></li><li><a href="global.html#batchSendWxRobotBase64Img">batchSendWxRobotBase64Img</a></li><li><a href="global.html#sendWxRobotBase64Img">sendWxRobotBase64Img</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">tam/parse/custom-event.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { getPartRatio } from '../../base/number';

/**
 * 处理事件数据
 * @param {object} options 配置
 * @example
 *
 * const res = getExtraEventData({
 *   data: {
 *     LAUNCH_GAME_WX_SUC: 2,
 *     LAUNCH_GAME_WX_FAIL: 1,
 *     ENTER_GAME_WX_SUC: 2,
 *     ENTER_GAME_WX_FAIL: 6,
 *   },
 *   eventMap: {
 *     WX_SUC: {
 *       // 总和
 *       type: 'SUMMARY',
 *       target: ['LAUNCH_GAME_WX_SUC', 'ENTER_GAME_WX_SUC'],
 *     },
 *     WX_FAIL: {
 *       // 总和
 *       type: 'SUMMARY',
 *       target: ['LAUNCH_GAME_WX_FAIL', 'ENTER_GAME_WX_FAIL'],
 *     },
 *     WX_SUMMARY: {
 *       // 总和
 *       type: 'SUMMARY',
 *       target: ['WX_SUC', 'WX_FAIL'],
 *     },
 *     WX_SUC_RATIO: {
 *       // 比例
 *       type: 'RATIO',
 *       target: [
 *         // 分母部分
 *         ['WX_SUMMARY'],
 *         // 分子部分
 *         ['WX_SUC'],
 *       ],
 *     },
 *   },
 * });
 *
 * console.log(res);
 *
 * // 结果如下：
 * {
 *   WX_SUC: 4,
 *   WX_FAIL: 7,
 *   WX_SUMMARY: 11,
 *   WX_SUC_RATIO: 36.36,
 * }
 *
 *
 */
export function getExtraEventData({
  data,
  eventMap,
}) {
  const res: any = {};
  Object.keys(eventMap).forEach((event) =&gt; {
    const info = eventMap[event] || {};
    const { target, type } = info;
    if (type === 'SUMMARY') {
      res[event] = getEventSummary(target, data, res) || 0;
    } else if (type === 'RATIO') {
      const { 0: summary = [], 1: part = [] } = target;
      res[event] = getPartRatio(getEventSummary(summary, data, res), getEventSummary(part, data, res)) || 0;
    }
  });

  res.ALL_SUMMARY = Object.keys(res)
    .filter(key =&gt; key.endsWith('_SUMMARY'))
    .reduce((acc, item) =&gt; acc + res[item], 0);
  res.ALL_FAIL = Object.keys(res)
    .filter(key =&gt; key.endsWith('_FAIL'))
    .reduce((acc, item) =&gt; acc + res[item], 0);

  res.ALL_FAIL_RATIO = getPartRatio(res.ALL_SUMMARY, res.ALL_FAIL);
  return res;
}


/**
 * 获取数据综合
 * @ignore
 * @param keyList keyList
 * @param dataMap dataMap
 * @param extraDataMap extraDataMap
 * @returns 数据综合
 */
function getEventSummary(keyList, dataMap, extraDataMap) {
  return keyList.reduce((acc, item) =&gt; acc + (dataMap[item] || extraDataMap[item] || 0), 0);
}


/**
 * 解析额外数据
 * @param eventDataMap 数据map
 * @returns 解析后的数据
 * @example
 * const eventDataMap = {
 * '57706': {
    LAUNCH_GAME_FAIL_GP_HELPER: 2,
    LAUNCH_GAME_FAIL_QQ: 228,
    extraData: {
      JUMP_LIVE_ACCOUNT_CONSOLE_SUC: 27,
      LAUNCH_GAME_FAIL_MP: 11,
      LAUNCH_GAME_SUC_MP: 261,
    }
  },
  '62653': {
 * }
 *
 * const res = parseExtraData(eventDataMap)
 * console.log(res)
 * {
 *   57706: {
 *   LAUNCH_GAME_FAIL_GP_HELPER: 2,
     LAUNCH_GAME_FAIL_QQ: 228,
 *   EXTRA_DATA_JUMP_LIVE_ACCOUNT_CONSOLE_SUC: 27,
     EXTRA_DATA_LAUNCH_GAME_FAIL_MP: 11,
     EXTRA_DATA_LAUNCH_GAME_SUC_MP: 261,
 *   },
     62653: {
      // ...
     }
 * }
 */
function parseExtraData(eventDataMap) {
  const res = {};
  console.log('parseExtraData.eventDataMap', eventDataMap);
  Object.keys(eventDataMap).forEach((projectId) =&gt; {
    const eventData = eventDataMap[projectId];
    if (eventData.extraData) {
      Object.keys(eventData.extraData).forEach((key) =&gt; {
        eventData[`EXTRA_DATA_${key}`] = eventData.extraData[key];
      });
      delete eventData.extraData;
    }
    res[projectId] = eventData;
  });
  console.log('parseExtraData.res', res);
  return res;
}


/**
     * 解析自定义事件数据
     * @param options 配置
     * @returns 解析后的数据
     * @example
     *
     * const eventDataMap = {
     * {
      '57706': {
        AI_PLAYER_EVENT_0: 10063,
        AI_PLAYER_EVENT_14: 16,
        AI_PLAYER_EVENT_300001: 9325,
        AI_PLAYER_EVENT_4: 25,
        LAUNCH_GAME_FAIL_GP_HELPER: 2,
        LAUNCH_GAME_FAIL_QQ: 228,
        LAUNCH_GAME_FAIL_WX: 3,
       },
        '62653': {
          // ...
        }
      }
     * }

      const eventMap = {
        WX_SUC: {
        type: 'SUMMARY',
        target: [ 'ENTER_GAME_WX_SUC', 'LAUNCH_GAME_SUC_WX' ]
      },
      WX_FAIL: {
        type: 'SUMMARY',
        target: [ 'ENTER_GAME_WX_FAIL', 'LAUNCH_GAME_FAIL_WX' ]
      },
      WX_SUMMARY: {
        type: 'SUMMARY',
        target: [
          'WX_SUC',
          'WX_FAIL',
          'ENTER_GAME_WX_NO_PERMISSION',
          'LAUNCH_GAME_WX_NO_PERMISSION',
          'ENTER_GAME_WX_ACCESS_DENIED',
          'LAUNCH_GAME_WX_ACCESS_DENIED'
        ]
      },
      // ...
      }
      const res = parseMultiCustomEvent({
        eventDataMap,
        eventMap,
      })
     * console.log(res)
     *[
      {
        projectId: { name: 'projectId', value: '57706' },
        WX_SUC: { name: 'WX_SUC', value: 1184 },
        WX_FAIL: { name: 'WX_FAIL', value: 3 },
        WX_SUMMARY: { name: 'WX_SUMMARY', value: 1262 },
        WX_FAIL_RATIO: { name: 'WX_FAIL_RATIO', value: 0.24 },
        QQ_SUC: { name: 'QQ_SUC', value: 1807 },
      },
      {
        projectId: { name: 'projectId', value: '62653' },
        // ...
      }
      ]
     */
export function parseMultiCustomEvent({
  eventDataMap,
  eventMap,
  projectIdMap = {},
  sortKeyList,
}) {
  const parsedEventData = parseExtraData(eventDataMap);

  const res: any = [];
  Object.keys(parsedEventData).forEach((projectId) =&gt; {
    const eventData = eventDataMap[projectId];
    const parsedData = getExtraEventData({
      data: eventData,
      eventMap,
    });

    // 统一格式，类似于：[ { ProjectName: { name: 'ProjectName', value: '脚手架' } } ]
    let initial = {
      ProjectName: { name: 'ProjectName', value: projectIdMap[projectId]?.name },
    };

    initial = Object.keys(parsedData)
      .filter(item =&gt; sortKeyList.includes(item))
      .sort((a, b) =&gt; sortKeyList.indexOf(a) - sortKeyList.indexOf(b))
      .reduce((acc, key) =&gt; {
        acc[key] = { name: key, value: parsedData[key] };
        return acc;
      }, initial);

    res.push(initial);
  });
  console.log('parseMultiCustomEvent.res', res, eventDataMap, eventMap);
  return res;
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>Documentation generated on 2022-10-16 13:42:50 GMT+0000  by novlan1.</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer=""></script>


<script src="scripts/collapse.js" defer=""></script>


    <script src="./jsdoc.js"></script>
    


</body></html>