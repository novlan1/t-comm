<!DOCTYPE html><html lang="en"><head>
    
    <meta charset="utf-8">
    <title>tam/api/summary-score.ts - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer=""></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
console.log('Hello!')
  
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger">
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search">
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/novlan1/t-comm" target="_blank" class="menu-item" id="repository">Github repo</a></h2><h3>Classes</h3><ul><li><a href="JsDocHandler.html">JsDocHandler</a><ul class="methods"><li data-type="method" style="display: none;"><a href="JsDocHandler.html#.init">init</a></li></ul></li><li><a href="MorsePwd.html">MorsePwd</a><ul class="methods"><li data-type="method" style="display: none;"><a href="MorsePwd.html#.init">init</a></li><li data-type="method" style="display: none;"><a href="MorsePwd.html#clear">clear</a></li></ul></li></ul><h3>Global</h3><ul><li class="nav-separator">-------   base/function   -------</li><li><a href="global.html#parseFunction">parseFunction</a></li><li><a href="global.html#cached">cached</a></li><li class="nav-separator">---------   base/list   ---------</li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#shuffle">shuffle</a></li><li><a href="global.html#getAccCellWidth">getAccCellWidth</a></li><li><a href="global.html#isListAllEqual">isListAllEqual</a></li><li><a href="global.html#getKeyValuesMap">getKeyValuesMap</a></li><li><a href="global.html#getPreviousRatio">getPreviousRatio</a></li><li><a href="global.html#getMaxAndMinIdx">getMaxAndMinIdx</a></li><li><a href="global.html#flattenPreData">flattenPreData</a></li><li><a href="global.html#compareTwoList">compareTwoList</a></li><li class="nav-separator">--------   base/number   --------</li><li><a href="global.html#getUnitPreviousRatio">getUnitPreviousRatio</a></li><li><a href="global.html#getPartRatio">getPartRatio</a></li><li><a href="global.html#NUMBER_CHI_MAP">NUMBER_CHI_MAP</a></li><li><a href="global.html#getThousandSeparator">getThousandSeparator</a></li><li><a href="global.html#getThousandSeparator2">getThousandSeparator2</a></li><li class="nav-separator">--------   base/object   --------</li><li><a href="global.html#toHumpObj">toHumpObj</a></li><li><a href="global.html#extend">extend</a></li><li class="nav-separator">--------   base/string   --------</li><li><a href="global.html#camelize">camelize</a></li><li><a href="global.html#hyphenate">hyphenate</a></li><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#titleize">titleize</a></li><li><a href="global.html#lowerInitial">lowerInitial</a></li><li><a href="global.html#toUnicodeAt">toUnicodeAt</a></li><li><a href="global.html#toUnicode">toUnicode</a></li><li class="nav-separator">-----------   canvas   -----------</li><li><a href="global.html#mergeMultiCanvasPic">mergeMultiCanvasPic</a></li><li><a href="global.html#createCanvasTable">createCanvasTable</a></li><li class="nav-separator">------------   city   ------------</li><li><a href="global.html#getAreaData">getAreaData</a></li><li><a href="global.html#getAllAreaData">getAllAreaData</a></li><li><a href="global.html#getAreaCode">getAreaCode</a></li><li><a href="global.html#getProvName">getProvName</a></li><li><a href="global.html#getCityName">getCityName</a></li><li><a href="global.html#getAreaName">getAreaName</a></li><li class="nav-separator">-----------   cookie   -----------</li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html#setCookie">setCookie</a></li><li><a href="global.html#clearCookie">clearCookie</a></li><li><a href="global.html#clearAll">clearAll</a></li><li class="nav-separator">------------   cos   ------------</li><li><a href="global.html#uploadCOSFile">uploadCOSFile</a></li><li class="nav-separator">------------   css   ------------</li><li><a href="global.html#removeCss">removeCss</a></li><li class="nav-separator">------------   date   ------------</li><li><a href="global.html#getMonthDay">getMonthDay</a></li><li><a href="global.html#getMonthDay2">getMonthDay2</a></li><li><a href="global.html#isSameWeek">isSameWeek</a></li><li><a href="global.html#timeStampFormat">timeStampFormat</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#parseTime">parseTime</a></li><li><a href="global.html#getTimeAgo">getTimeAgo</a></li><li><a href="global.html#getTimeAgoOrDate">getTimeAgoOrDate</a></li><li><a href="global.html#getCountDownObj">getCountDownObj</a></li><li><a href="global.html#getDayStartTimestamp">getDayStartTimestamp</a></li><li><a href="global.html#getDayEndTimeStamp">getDayEndTimeStamp</a></li><li class="nav-separator">------------   env   ------------</li><li><a href="global.html#checkUAIsIOS">checkUAIsIOS</a></li><li><a href="global.html#getEnvUAType">getEnvUAType</a></li><li class="nav-separator">------------   git   ------------</li><li><a href="global.html#getGitCurBranch">getGitCurBranch</a></li><li><a href="global.html#getGitCommitInfo">getGitCommitInfo</a></li><li><a href="global.html#getGitLastTag">getGitLastTag</a></li><li><a href="global.html#getGitCommitsBeforeTag">getGitCommitsBeforeTag</a></li><li><a href="global.html#getGitAuthor">getGitAuthor</a></li><li class="nav-separator">-----------   jsdoc   -----------</li><li><a href="global.html#insertModuleNavSeparator">insertModuleNavSeparator</a></li><li class="nav-separator">-----------   loader   -----------</li><li><a href="global.html#loadJS">loadJS</a></li><li><a href="global.html#loadCSS">loadCSS</a></li><li class="nav-separator">----------   node-img   ----------</li><li><a href="global.html#saveBase64ImgToFile">saveBase64ImgToFile</a></li><li><a href="global.html#turnLocalImg2Base64">turnLocalImg2Base64</a></li><li><a href="global.html#saveRemoteImgToLocal">saveRemoteImgToLocal</a></li><li><a href="global.html#getImgMd5">getImgMd5</a></li><li class="nav-separator">-----   open-source-report   -----</li><li><a href="global.html#sendOpenSourceReport">sendOpenSourceReport</a></li><li class="nav-separator">----------   pipeline   ----------</li><li><a href="global.html#startPipeline">startPipeline</a></li><li class="nav-separator">----------   rainbow   ----------</li><li><a href="global.html#addOrUpdateRainbowKV">addOrUpdateRainbowKV</a></li><li><a href="global.html#addRainbowKV">addRainbowKV</a></li><li><a href="global.html#updateRainbowKV">updateRainbowKV</a></li><li><a href="global.html#createRainbowPublishJob">createRainbowPublishJob</a></li><li><a href="global.html#publishRainbowTask">publishRainbowTask</a></li><li><a href="global.html#closeRainbowTask">closeRainbowTask</a></li><li><a href="global.html#updateRainbowKVAndPublish">updateRainbowKVAndPublish</a></li><li><a href="global.html#queryGroupInfo">queryGroupInfo</a></li><li><a href="global.html#fetchRainbowConfig">fetchRainbowConfig</a></li><li class="nav-separator">----------   tam/api   ----------</li><li><a href="global.html#getCustomEventData">getCustomEventData</a></li><li><a href="global.html#getMultiCustomEventData">getMultiCustomEventData</a></li><li><a href="global.html#getSummaryScoreByGroupIdList">getSummaryScoreByGroupIdList</a></li><li class="nav-separator">----------   tam/img   ----------</li><li><a href="global.html#genCustomEventImg">genCustomEventImg</a></li><li><a href="global.html#genCustomEventImgAndSendRobot">genCustomEventImgAndSendRobot</a></li><li><a href="global.html#genSummaryData">genSummaryData</a></li><li><a href="global.html#genSummaryDataAndSendRobot">genSummaryDataAndSendRobot</a></li><li class="nav-separator">---------   tam/parse   ---------</li><li><a href="global.html#getExtraEventData">getExtraEventData</a></li><li><a href="global.html#parseExtraData">parseExtraData</a></li><li><a href="global.html#parseMultiCustomEvent">parseMultiCustomEvent</a></li><li><a href="global.html#getTableHeaders">getTableHeaders</a></li><li><a href="global.html#parseSummaryScore">parseSummaryScore</a></li><li class="nav-separator">------------   tgit   ------------</li><li><a href="global.html#getBranchLifeCycle">getBranchLifeCycle</a></li><li><a href="global.html#getProjectDefaultBranch">getProjectDefaultBranch</a></li><li><a href="global.html#getBranchesByProjectName">getBranchesByProjectName</a></li><li><a href="global.html#getOneBranchDetail">getOneBranchDetail</a></li><li><a href="global.html#getOneCommitDetail">getOneCommitDetail</a></li><li><a href="global.html#createMR">createMR</a></li><li><a href="global.html#getMrList">getMrList</a></li><li><a href="global.html#getOneMrComments">getOneMrComments</a></li><li><a href="global.html#getOneProjectDetail">getOneProjectDetail</a></li><li><a href="global.html#getOneProjectBySearch">getOneProjectBySearch</a></li><li><a href="global.html#getAllProjects">getAllProjects</a></li><li class="nav-separator">------------   url   ------------</li><li><a href="global.html#getQueryObj">getQueryObj</a></li><li><a href="global.html#composeUrlQuery">composeUrlQuery</a></li><li><a href="global.html#encodeUrlParam">encodeUrlParam</a></li><li><a href="global.html#decodeUrlParam">decodeUrlParam</a></li><li class="nav-separator">------------   util   ------------</li><li><a href="global.html#buildAndUpload">buildAndUpload</a></li><li><a href="global.html#readEnvVariable">readEnvVariable</a></li><li><a href="global.html#execCommand">execCommand</a></li><li><a href="global.html#writeEnvTokenToNpmRC">writeEnvTokenToNpmRC</a></li><li class="nav-separator">----------   validate   ----------</li><li><a href="global.html#isIdCard">isIdCard</a></li><li><a href="global.html#isRegExp">isRegExp</a></li><li><a href="global.html#isDate">isDate</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isExternal">isExternal</a></li><li><a href="global.html#validURL">validURL</a></li><li><a href="global.html#validLowerCase">validLowerCase</a></li><li><a href="global.html#validUpperCase">validUpperCase</a></li><li><a href="global.html#validAlphabets">validAlphabets</a></li><li><a href="global.html#validEmail">validEmail</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isQQNumber">isQQNumber</a></li><li><a href="global.html#isEmail">isEmail</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isTel">isTel</a></li><li class="nav-separator">--------   version-tip   --------</li><li><a href="global.html#genVersionAndSendChangeLog">genVersionAndSendChangeLog</a></li><li><a href="global.html#genVersionTip">genVersionTip</a></li><li><a href="global.html#genVersion">genVersion</a></li><li class="nav-separator">----------   weather   ----------</li><li><a href="global.html#fetchWeatherData">fetchWeatherData</a></li><li><a href="global.html#sendWeatherRobotMsg">sendWeatherRobotMsg</a></li><li><a href="global.html#getWeatherRobotContent">getWeatherRobotContent</a></li><li class="nav-separator">--------   wecom-robot   --------</li><li><a href="global.html#sendWxRobotMsg">sendWxRobotMsg</a></li><li><a href="global.html#sendWxRobotMarkdown">sendWxRobotMarkdown</a></li><li><a href="global.html#sendWxRobotImg">sendWxRobotImg</a></li><li><a href="global.html#batchSendWxRobotBase64Img">batchSendWxRobotBase64Img</a></li><li><a href="global.html#sendWxRobotBase64Img">sendWxRobotBase64Img</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">tam/api/summary-score.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { SecretInfoType, ScoreInfoType } from '../type';
import { getCredential } from './credential';
import { nodeGet } from '../../util/node-request';


/**
 * 根据项目id获取分数信息
 * @ignore
 * @param {object} options 参数
 * @param {Array&lt;number&gt;} options.projectIdList 项目Id列表
 * @param {string} options.date 日期，yyyyMMdd格式
 * @param {object} options.secretInfo 密钥信息
 * @param {string} options.secretInfo.apiKey apiKey
 * @param {string} options.secretInfo.loginName loginName
 * @param {Function} options.secretInfo.getPwdCode getPwdCode
 * @param {Function} options.secretInfo.encrypt encrypt
 * @returns {Promise&lt;Array&lt;object&gt;&gt;} 分数信息
 * @example
 * getScoreInfoByProjectId({
 *   projectId: 123123,
 *   date: 20210106
 *   secretInfo: {
 *     apiKey: '',
 *     loginName: '',
 *     getPwdCode() {},
 *     encrypt() {},
 *   }
 * }).then((data) =&gt; {
 *   console.log(data)
 * })
 *
 * [
 *   {
 *     ProjectName: '社区',
 *     PagePv: 99,
 *     PageError: 0,
 *     PageDuration: 1409.8333,
 *     StaticFail: 8,
 *     CreateTime: '',
 *     ProjectId: 123123,
 *     PageUv: 23,
 *     ApiNum: 521,
 *     ApiFail: 78,
 *     ApiDuration: 1813.3333,
 *     StaticNum: 1494,
 *     StaticDuration: 103.75,
 *     Score: 80.9167,
 *     CreateUser: 'lee',
 *     GroupName: 'aGroup',
 *   },
 * ]
 *
 */
async function getScoreInfoByProjectId({
  projectId,
  startDate,
  secretInfo,
}: {
  projectId: number
  startDate: string
  secretInfo: SecretInfoType
}) {
  const credential = await getCredential(secretInfo);

  const result = await nodeGet()({
    url: `http://tamapi.woa.com/api/interface/pro/scoreInfo?projectID=${projectId}&amp;startDate=${startDate}`,
    headers: {
      ...credential,
    },
  });

  let res = [];
  try {
    res = JSON.parse(result.body).message || [];
  } catch (e) {}
  return res;
}

/**
 * 根据 groupId 获取项目列表
 * @ignore
 * @param {object} options 配置
 * @param {number} options.groupId 小组Id
 * @param {object} options.secretInfo 密钥信息
 * @param {string} options.secretInfo.apiKey apiKey
 * @param {string} options.secretInfo.loginName loginName
 * @param {Function} options.secretInfo.getPwdCode getPwdCode
 * @param {Function} options.secretInfo.encrypt encrypt
 * @returns {Promise&lt;array&lt;object&gt;&gt;} 项目列表
 * @example
 * getProjectByGroupId({
 *   groupId: 1,
 *   secretInfo: {
 *     apiKey: '',
 *     loginName: '',
 *     getPwdCode() {},
 *     encrypt() {},
 *   }
 * }).then(resp =&gt; {
 *   console.log(resp)
 * })
 * [
 *   {
 *     ID: 56564,
 *     ProjectName: 'name',
 *     ProjectDesc: 'desc',
 *     ProjectKey: 'xxx',
 *     ProjectType: 'web',
 *     GroupId: 123,
 *     GroupName: 'xxx',
 *     GroupKey: 'xxx',
 *     InstanceID: 'rum-xxx',
 *     Url: '*.qq.com',
 *     CodePath: '',
 *     Rate: '100',
 *     CreateUser: 'xxx',
 *     EnableUrlGroup: true,
 *     KafkaHost: '',
 *     KafkaTopic: '',
 *     KafkaVersion: '',
 *     SaslUserName: '',
 *     SaslPassword: '',
 *     SaslMechanism: '',
 *     IsFollow: false,
 *     CreateTime: '2021-10-01T11:34:32+08:00',
 *   },
 *   {
 *     ID: 12345,
 *     // ...
 *   },
 * ];
 *
 */
async function getProjectByGroupId({
  groupId,
  secretInfo,
}: {
  groupId: number
  secretInfo: SecretInfoType
}) {
  const credential = await getCredential(secretInfo);

  const result = await nodeGet()({
    url: ` http://tamapi.woa.com/api/interface/pro/list?groupID=${groupId}`,
    headers: {
      ...credential,
    },
  });
  let res = [];
  try {
    res = JSON.parse(result.body).result || [];
  } catch (e) {}
  return res;
}

/**
 * 根据 groupIdList 获取 projectList
 * @ignore
 * @param {object} options 配置
 * @param {Array&lt;number&gt;} options.groupIdList 小组Id列表
 * @param {object} options.secretInfo 密钥信息
 * @param {string} options.secretInfo.apiKey apiKey
 * @param {string} options.secretInfo.loginName loginName
 * @param {Function} options.secretInfo.getPwdCode getPwdCode
 * @param {Function} options.secretInfo.encrypt encrypt
 * @returns {Array&lt;object&gt;} 项目列表
 * @example
 * getAllProjectList({
 *   groupIdList: [1,2,3],
 *   secretInfo: {
 *     apiKey: '',
 *     loginName: '',
 *     getPwdCode() {},
 *     encrypt() {},
 *   }
 * }).then(resp =&gt; {
 *   console.log('resp)
 * })
 * [
 *   {
 *     ID: 56564,
 *     ProjectName: 'name',
 *     ProjectDesc: 'desc',
 *     ProjectKey: 'xxx',
 *     ProjectType: 'web',
 *     GroupId: 123,
 *     GroupName: 'xxx',
 *     GroupKey: 'xxx',
 *     InstanceID: 'rum-xxx',
 *     Url: '*.qq.com',
 *     CodePath: '',
 *     Rate: '100',
 *     CreateUser: 'xxx',
 *     EnableUrlGroup: true,
 *     KafkaHost: '',
 *     KafkaTopic: '',
 *     KafkaVersion: '',
 *     SaslUserName: '',
 *     SaslPassword: '',
 *     SaslMechanism: '',
 *     IsFollow: false,
 *     CreateTime: '2021-10-01T11:34:32+08:00',
 *   },
 *   {
 *     ID: 12345,
 *     // ...
 *   },
 * ];
 */
async function getAllProjectList({
  groupIdList,
  secretInfo,
}: {
  groupIdList: Array&lt;number&gt;
  secretInfo: SecretInfoType
}): Promise&lt;Array&lt;{ID: number}&gt;&gt; {
  const res: Array&lt;{ID: number}&gt; = [];
  for (const groupId of groupIdList) {
    const projectList = await getProjectByGroupId({
      groupId,
      secretInfo,
    });
    res.push(...(projectList || []));
  }
  return res;
}


/**
 * 根据 projectIdList 获取一天的汇总分数
 * @ignore
 * @param {object} options 参数
 * @param {Array&lt;number&gt;} options.projectIdList 项目Id列表
 * @param {string} options.date 日期，yyyyMMdd格式
 * @param {object} options.secretInfo 密钥信息
 * @param {string} options.secretInfo.apiKey apiKey
 * @param {string} options.secretInfo.loginName loginName
 * @param {Function} options.secretInfo.getPwdCode getPwdCode
 * @param {Function} options.secretInfo.encrypt encrypt
 * @returns {Promise&lt;Array&lt;object&gt;&gt;} 分数列表
 *
 * @example
 * getSummaryScoreByProjectIdList({
 *   projectIdList: [123123, 111],
 *   date: 20210106
 *   secretInfo: {
 *     apiKey: '',
 *     loginName: '',
 *     getPwdCode() {},
 *     encrypt() {},
 *   }
 * }).then((data) =&gt; {
 *   console.log(data)
 * })
 *
 * [
 *   {
 *     ProjectName: 'name',
 *     PagePv: 99,
 *     PageError: 0,
 *     PageDuration: 1409.8333,
 *     StaticFail: 8,
 *     CreateTime: '',
 *     ProjectId: 123123,
 *     PageUv: 23,
 *     ApiNum: 521,
 *     ApiFail: 78,
 *     ApiDuration: 1813.3333,
 *     StaticNum: 1494,
 *     StaticDuration: 103.75,
 *     Score: 80.9167,
 *     CreateUser: 'xxx',
 *     GroupName: 'xxx',
 *   },
 *   {
 *     // ...
 *   }
 * ]
 */
async function getSummaryScoreByProjectIdList({
  projectIdList,
  date,
  secretInfo,
}: {
  projectIdList: Array&lt;number&gt;
  date: string
  secretInfo: SecretInfoType
}) {
  const res = [];
  for (const projectId of projectIdList) {
    const temp = await getScoreInfoByProjectId({ projectId, startDate: date, secretInfo });
    res.push(...(temp || []));
  }
  return res;
}

/**
 * 根据 groupIdList 获取汇总数据
 * @param {object} options 配置
 * @param {string} options.date 日期，yyyyMMdd格式
 * @param {Array&lt;number&gt;} options.groupIdList groupId列表
 * @param {object} options.secretInfo 密钥信息
 * @param {string} options.secretInfo.apiKey apiKey
 * @param {string} options.secretInfo.loginName loginName
 * @param {Function} options.secretInfo.getPwdCode getPwdCode
 * @param {Function} options.secretInfo.encrypt encrypt
 * @returns {Promise&lt;({ data: object, projectIdList: Array&lt;number&gt; })&gt;} 汇总数据
 * @example
 * getSummaryScoreByGroupIdList({
 *   groupIdList: [1,2,3],
 *   date: '20210106',
 *   secretInfo: {
 *     apiKey: '',
 *     loginName: '',
 *     getPwdCode() {},
 *     encrypt() {},
 *   }
 * }).then(resp =&gt; {
 *   console.log(resp)
 * })
 *
 * {
 *   data:
 *   [
 *     {
 *       ProjectName: '社区',
 *       PagePv: 99,
 *       PageError: 0,
 *       PageDuration: 1409.8333,
 *       StaticFail: 8,
 *       CreateTime: '',
 *       ProjectId: 123123,
 *       PageUv: 23,
 *       ApiNum: 521,
 *       ApiFail: 78,
 *       ApiDuration: 1813.3333,
 *       StaticNum: 1494,
 *       StaticDuration: 103.75,
 *       Score: 80.9167,
 *       CreateUser: 'lee',
 *       GroupName: 'aGroup',
 *     },
 *     {
 *       ProjectId: 123,
 *       // ...
 *     },
 *   ],
 *   projectIdList: [
 *     123123,
 *     123,
 *   ],
 * };
 *
 */
export async function getSummaryScoreByGroupIdList({
  date,
  groupIdList,
  secretInfo,
}: {
  date: string
  groupIdList: Array&lt;number&gt;
  secretInfo: SecretInfoType
}): Promise&lt;({ data: Array&lt;ScoreInfoType&gt;, projectIdList: Array&lt;number&gt; })&gt; {
  const projectList = await getAllProjectList({
    groupIdList,
    secretInfo,
  });
  const projectIdList = projectList.map(item =&gt; item.ID);
  const res = await getSummaryScoreByProjectIdList({
    date,
    projectIdList,
    secretInfo,
  });

  return { data: res, projectIdList };
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>Documentation generated on 2022-10-16 14:57:53 GMT+0000  by novlan1.</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer=""></script>


<script src="scripts/collapse.js" defer=""></script>


    <script src="./jsdoc.js"></script>
    


</body></html>